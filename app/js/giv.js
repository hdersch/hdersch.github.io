Preambel = `
   GeoImageViewer - Image Viewer linked to Maps
   Version 0.1 for HTML-browsers

   Copyright (C) 2021 - Helmut Dersch  der@hs-furtwangen.de
   
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2, or (at your option)
   any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  `;
"use strict";function $(a){if(a.startsWith("#")){return document.getElementById(a.substring(1))}if(a.startsWith(".")){return document.getElementsByClassName(a.substring(1))}return document.getElementsByTagName(a)}$.addStyle=function(a){let styleSheet=document.createElement("style");styleSheet.type="text/css";styleSheet.innerText=a;document.head.appendChild(styleSheet)};$.addManifest=function(a){let m=document.createElement("manifest");m.type="application/manifest+json";m.innerText=a;document.head.appendChild(m)};$.exportObj=function(b){function a(d){var c=document.createElement("p");c.appendChild(document.createTextNode(d));return c.innerHTML}let json=window.open("","","width=600,height=600,menubar=yes,toolbar=yes,scrollbars=yes");json.document.write("<pre>\n"+a(JSON.stringify(b,null,3))+"</pre>")};$.load=function(a,c,b){let xhttp=new XMLHttpRequest();if(b){xhttp.responseType=b}xhttp.onload=function(){if(xhttp.status==200){c(xhttp.response)}else{console.log("Error, status "+xhttp.status);c()}};xhttp.onerror=function(){console.log("Error, request failed");c()};xhttp.open("GET",a,true);xhttp.send();return};$.getXML=function(a,b){if(!b){return null}if(Array.isArray(a)){if(a.length==0){return null}else{if(a.length==1){a=a[0]}else{let first=a.splice(0,1);return $.getXML(a,$.getXML(first,b))}}}let k=b.indexOf("<"+a+">");if(k>=0){k+=("<"+a+">").length}else{k=b.indexOf("<"+a+" ");if(k>=0){k=b.indexOf(">",k+("<"+a+" ").length);if(k>=0){k++}}}if(k<0){return null}let j=b.indexOf("</"+a+">",k);if(j<0){return null}return b.substring(k,j).trim()};$.arrayRemove=function(b,a){if((typeof a)=="function"){for(let k=0;k<b.length;k++){if(a(b[k])){return b.splice(k--,1)}}return null}else{for(let k=0;k<b.length;k++){if(b[k]==a){b.splice(k--,1)}}}};$.get=function(a,b,c){for(let k=0;k<c.length;k++){let x=c[k];if(a in x&&x[a]==b){return x}}return null};$.getOpt=function(a){let q=window.location.href,k=q.indexOf("?");if(k<0){return}if(q.endsWith("#")){q=q.substring(0,q.length-1)}q=q.substring(k+1).split("&");for(k=0;k<q.length;k++){let opt=q[k],j=opt.indexOf("=");if(j<0){a[opt]=true}else{let key=opt.substring(0,j).trim(),val=opt.substring(j+1).trim();if(val.toLowerCase()=="true"){a[key]=true}else{if(val.toLowerCase()=="false"){a[key]=false}else{let n=parseFloat(val);if(isNaN(n)){a[key]=val}else{a[key]=n}}}}}};$.loadSVG='\n<svg version="1.1"  xmlns="http://www.w3.org/2000/svg"  x="0px" y="0px"\nwidth="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">\n\n<path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946\ns14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634\nc0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>\n<path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0\nC22.32,8.481,24.301,9.057,26.013,10.047z">\n<animateTransform attributeType="xml"\nattributeName="transform"\ntype="rotate"\nfrom="0 20 20"\nto="360 20 20"\ndur="0.5s"\nrepeatCount="indefinite"/>\n</path>\n</svg>\n';"use strict";var M={max:function(e){let km=0;for(let k=1;k<e.length;k++){if(e[k]>e[km]){km=k}}return km},mv_mult:function(g,e){let r=new Array();let n=g.length;let m=e.length;for(let i=0;i<n;i++){r[i]=0;for(let k=0;k<m;k++){r[i]+=g[i][k]*e[k]}}return r},vs_mult:function(g,e){let r=new Array();let n=g.length;for(let i=0;i<n;i++){r[i]=g[i]*e}return r},vv_mult:function(g,e){let r=0;let n=g.length;for(let i=0;i<n;i++){r+=g[i]*e[i]}return r},mm_mult:function(g,e){let r=new Array();let n=g.length;let m=e[0].length;let p=g[0].length;for(let i=0;i<n;i++){r[i]=new Array();for(let k=0;k<m;k++){let x=0;for(let j=0;j<p;j++){x+=g[i][j]*e[j][k]}r[i][k]=x}}return r},mm_add:function(g,e){let r=new Array();let n=g.length,m=g[0].length;for(let i=0;i<n;i++){r[i]=new Array();for(let k=0;k<m;k++){r[i][k]=g[i][k]+e[i][k]}}return r},rot:function(g,e,h){let sa=Math.sin(g),ca=Math.cos(g),sb=Math.sin(e),cb=Math.cos(e),sc=Math.sin(h),cc=Math.cos(h);let A=[[1,0,0],[0,ca,sa],[0,-sa,ca]];let B=[[cb,0,sb],[0,1,0],[-sb,0,cb]];let C=[[cc,-sc,0],[sc,cc,0],[0,0,1]];return M.mm_mult(M.mm_mult(C,A),B)},rangles:function(e){let sa=-e[2][1];let a=Math.asin(sa);if(Math.abs(sa)==1){let c=0;let b=Math.atan2(-sa*e[1][0],e[0][0]);return{a:a,b:b,c:c}}let b=Math.atan2(-e[2][0],e[2][2]);let c=Math.atan2(-e[0][1],e[1][1]);return{a:a,b:b,c:c}},v_sub:function(g,e){let c=new Array();for(let k=0;k<g.length;k++){c[k]=g[k]-e[k]}return c},v_add:function(g,e){let c=new Array();for(let k=0;k<g.length;k++){c[k]=g[k]+e[k]}return c},m_sub:function(g,e){let c=new Array();for(let k=0;k<g.length;k++){c[k]=new Array();for(let i=0;i<g[0].length;i++){c[k][i]=g[k][i]-e[k][i]}}return c},norm:function(e){if(!Array.isArray(e)){return Math.abs(e)}if(e.length==0){return 0}if(!Array.isArray(e[0])){let n=0;for(let k=0;k<e.length;k++){n+=e[k]*e[k]}return Math.sqrt(n)}let nr=e.map(M.norm);return M.norm(nr)},d2r:function(e){return e*Math.PI/180},r2d:function(e){return e*180/Math.PI},polyval:function(g,e){let y=0;for(let k=0;k<g.length;k++){y=y*e+g[k]}return y},trans:function(e){let n=e.length,m=e[0].length;let b=new Array();for(let k=0;k<m;k++){b[k]=new Array();for(let j=0;j<n;j++){b[k][j]=e[j][k]}}return b},diag:function(e){let r;if(!Array.isArray(e[0])){r=M.zeros(e.length,e.length);for(let k=0;k<e.length;k++){r[k][k]=e[k]}return r}r=new Array();for(let k=0;k<Math.min(e.length,e[0].length);k++){r[k]=e[k][k]}return r},eye:function(e){let r=new Array();for(let k=0;k<e;k++){r[k]=new Array();for(let j=0;j<e;j++){r[k][j]=(k==j?1:0)}}return r},col:function(e,g){let r=new Array();for(let k=0;k<e.length;k++){r[k]=e[k][g]}return r},setcol:function(h,g,e){for(let k=0;k<h.length;k++){e[k][g]=h[k]}},sum:function(e){let s=0;for(let k=0;k<e.length;k++){s+=e[k]}return s},ones:function(e){let x=new Array();for(let k=0;k<e;k++){x[k]=1}return x},zeros:function(g,e){let x=new Array();if(e==0){for(let k=0;k<g;k++){x[k]=0}return x}for(let k=0;k<g;k++){x[k]=new Array();for(let i=0;i<e;i++){x[k][i]=0}}return x},pivot:function(g,h,e,l){let pivot=h,nr=g.length,nc=g[0].length;if(h>=nc||h>=nr){return h}let maxa=Math.abs(g[h][h]);for(let i=h+1;i<nr;i++){let d=Math.abs(g[i][h]);if(d>maxa){maxa=d;pivot=i}}if(maxa==0){let kn=M.pivot(g,h+1,e,l);if(kn==h+1){return h}else{return kn}}if(pivot!=h){let d;for(let j=h;j<nc;j++){d=g[pivot][j];g[pivot][j]=g[h][j];g[h][j]=d}if(e!=null){for(let j=0;j<nc;j++){d=e[pivot][j];e[pivot][j]=e[h][j];e[h][j]=d}}if(l!=null){d=l[pivot];l[pivot]=l[h];l[h]=d}}return pivot},linsolve:function(e,g){if(e.length!=e[0].length||e.length!=g.length){return null}let n=e.length;for(let k=0;k<n-1;k++){M.pivot(e,k,null,g);let d=e[k][k];if(d==0){return null}for(let i=k+1;i<n;i++){let f=e[i][k]/d;for(let j=k+1;j<n;j++){e[i][j]-=f*e[k][j]}g[i]-=f*g[k]}}if(e[n-1][n-1]==0){return null}let x=new Array();x[n-1]=g[n-1]/e[n-1][n-1];for(let i=n-2;i>=0;i--){let s=0;for(let j=i+1;j<n;j++){s+=e[i][j]*x[j]}x[i]=(g[i]-s)/e[i][i]}return x},det:function(e){if(e.length!=e[0].length){return 0}let n=e.length;let perm=1;for(let k=0;k<n-1;k++){if(M.pivot(e,k,null,null)!=k){perm*=-1}let d=e[k][k];if(d==0){return 0}for(let i=k+1;i<n;i++){let f=e[i][k]/d;for(let j=k+1;j<n;j++){e[i][j]-=f*e[k][j]}}}for(let k=0;k<n;k++){perm*=e[k][k]}return perm},bisection:function(o,l,h,g){let y1=o(l),y2=o(h);if(y1*y2>0){return NaN}var e,q;while(Math.abs(h-l)>g){e=(h+l)/2,q=o(e);let yt=q*y1;if(yt==0){return e}if(yt<0){h=e;y2=q}else{l=e;y1=q}}return h-y2*(h-l)/(y2-y1)},diff:function(g,e){return function(h){return(g(h+e)-g(h-e))/(2*e)}},grad:function(l,g){var e=function(u,t,q,o){for(let j=0;j<t.length;j++){u[j]=t[j]}u[o]+=q;return u};return function(h){let y=new Array(),y1,y2,xd=new Array();for(let k=0;k<h.length;k++){y1=l(e(xd,h,g,k));y2=l(e(xd,h,-g,k));y[k]=(y1-y2)/(2*g)}return y}},grad_desc:function(h,e,g,l){let F=h(e),Fn;while(g>l){let grad=M.grad(h,l/10000)(e);let n_grad=M.norm(grad);if(n_grad==0){break}grad=M.vs_mult(grad,g/n_grad);let an=M.v_sub(e,grad);while((Fn=h(an))<F){e=an;F=Fn;an=M.v_sub(e,grad)}g/=2}return e},round_dec:function(e,g){return parseFloat(e.toFixed(g))},round_sig:function(e,g){let ld=Math.floor(Math.log10(e)),d=Math.pow(10,ld);return M.round_dec(e/d,g)*d},dist_lines:function(g,e){let x1=g.P[0],y1=g.P[1],z1=g.P[2];let l1=g.R[0],m1=g.R[1],n1=g.R[2];let x2=e.P[0],y2=e.P[1],z2=e.P[2];let l2=e.R[0],m2=e.R[1],n2=e.R[2];return Math.abs(M.det([[x1-x2,y1-y2,z1-z2],[l1,m1,n1],[l2,m2,n2]]))/M.norm([M.det([[l1,m1],[l2,m2]]),M.det([[m1,n1],[m2,n2]]),M.det([[n1,l1],[n2,l2]])])},cross:function(g,e){return[g[1]*e[2]-g[2]*e[1],g[2]*e[0]-g[0]*e[2],g[0]*e[1]-g[1]*e[0]]},dist_lines2:function(g,e){let a=g.P,v=g.R,b=e.P,w=e.R;let n=M.cross(v,w);let A=M.zeros(3,3);M.setcol(v,0,A);M.setcol(w,1,A);M.setcol(n,2,A);let r=M.linsolve(A,M.v_sub(b,a));return{P1:M.v_add(a,M.vs_mult(v,r[0])),P2:M.v_add(b,M.vs_mult(w,-r[1])),d:Math.abs(r[2])*M.norm(n)}}};function ImageViewer(c,F){if(F){$.addStyle("#"+c+F)}var g=document.getElementById(c);var K=null;var f=0;var C=0;var a=1;var y=false;var l=-1;var i=-1;var p=-1;var n=-1;var E=new Array();var D=0;this.marker=null;var w=this;$.addStyle(ImageViewer.styles);var H=document.createElement("button");H.classList.add("iv_zoom");H.innerHTML="+".bold();g.parentElement.appendChild(H);H.addEventListener("click",function(){B(g.width/2,g.height/2,-1)});var J=document.createElement("button");J.classList.add("iv_zoom");J.innerHTML="&#x2212;".bold();g.parentElement.appendChild(J);J.addEventListener("click",function(){B(g.width/2,g.height/2,1)});var o=document.createElement("img");o.setAttribute("src","data:image/svg+xml,"+encodeURIComponent($.loadSVG));o.style.display="none";o.style.position="absolute";o.style.zIndex="100000";g.parentElement.appendChild(o);this.repaint=function(){let lw=(g.width/2);o.width=lw;o.height=lw;o.style.top=(g.offsetTop+(g.height-lw)/2)+"px";o.style.left=(g.offsetLeft+lw/2)+"px";H.style.top=(g.offsetTop+12)+"px";H.style.left=(g.offsetLeft+12)+"px";J.style.left=(g.offsetLeft+12)+"px";J.style.top=(g.offsetTop+12+32+4)+"px";q();G()};var A=function(L,O){var N={x:(L-f*a)/a,y:(O-C*a)/a};switch(D){case 0:break;case 90:N={x:K.width-N.y-1,y:N.x};break;case -90:N={x:N.y,y:K.height-N.x-1};break;case 180:N={x:K.width-N.x-1,y:K.height-N.y-1};break}return N};var h=function(L,N){switch(D){case 0:return{x:a*(L+f),y:a*(N+C)};case 90:return{x:a*(N+f),y:a*(K.width-L-1+C)};case -90:return{x:a*(K.height-N-1+f),y:a*(L+C)};case 180:return{x:a*(K.width-L-1+f),y:a*(K.height-N-1+C)}}};this.thumbNail=function(P){if(!K){return null}var L,O;if(K.width>K.height){O=P;L=Math.round(P*K.width/K.height)}else{L=P;O=Math.round(P*K.height/K.width)}var Q=document.createElement("canvas");Q.style.display="none";document.body.appendChild(Q);var N=Q.getContext("2d");if(D==0){Q.width=L;Q.height=O;N.drawImage(K,0,0,L,O)}else{if(D==-90){Q.width=O;Q.height=L;N.rotate(Math.PI/2);N.drawImage(K,0,-O,L,O)}else{if(D==90){Q.width=O;Q.height=L;N.rotate(-Math.PI/2);N.drawImage(K,-L,0,L,O)}}}let imgAsDataURL=Q.toDataURL("image/jpeg",0.5);document.body.removeChild(Q);return imgAsDataURL};this.markTrack=function(L){E.push(L);L.show=true;u()};var u=function(){var N,P;var L=g.getContext("2d");for(N=0;N<E.length;N++){var Q=E[N];if(!Q.show){continue}L.strokeStyle=(Q.color?Q.color:"#CC3333");L.lineWidth=3;L.beginPath();var O=h(Q[0],Q[1]);L.moveTo(O.x,O.y);for(P=2;P<Q.length;P+=2){O=h(Q[P],Q[P+1]);L.lineTo(O.x,O.y)}L.stroke()}};this.show_image=function(O,N,L){K=document.createElement("img");K.src=O;K.alt=O;l=-1;i=-1;this.marker=null;E=new Array();D=(N?N:0);o.style.display="block";K.onload=function(){o.style.display="none";var P=K.naturalWidth,Q=K.naturalHeight;if(D==90||D==-90){P=K.naturalHeight,Q=K.naturalWidth}if(Q<g.height&&P<g.width){a=1;f=(g.width-P)/2;C=(g.height-Q)/2}else{a=g.width/P;f=0;C=(g.height-a*Q)/(2*a)}if(L){L(K.naturalWidth,K.naturalHeight)}w.repaint()};K.onerror=function(){o.style.display="none";alert("Could not load image "+O)}};var I=function(L){if(w.marker){let mkcanvas=h(w.marker.x,w.marker.y);f+=(g.width/(2*a)-mkcanvas.x/a)/L;C+=(g.height/(2*a)-mkcanvas.y/a)/L}};var b;this.mark=function(N){this.marker=new j(N.x,N.y,N.color);if(N.x2){this.marker.more=new j(N.x2,N.y2,N.color2)}if(N.center){clearInterval(b);var L=0,P=10;function O(){if(L==2*P){clearInterval(b)}else{I(P/2);q();G();L++}}b=setInterval(O,10)}else{q();G()}};this.showTracks=function(L,N){for(let k=0;k<E.length;k++){let t=E[k];if(!N||(t.name&&t.name==N)){t.show=L}}q()};this.rmTrack=function(L){let t=$.arrayRemove(E,function(N){return N.name&&N.name==L});if(t){q();return t[0]}return null};this.handleclick=this.mark;$.addStyle("#"+g.id+":hover { cursor: crosshair;}");$.addStyle("#"+g.id+":active { cursor: grab;}");g.addEventListener("click",function(L){if(l==L.offsetX&&i==L.offsetY){if(!d()){let xy=A(L.offsetX,L.offsetY);if(xy.x>=0&&xy.x<K.width&&xy.y>=0&&xy.y<K.height){w.handleclick(xy)}}else{if(!e){w.marker=null;q()}}}});this.focus=false;window.addEventListener("keyup",function(L){if(w.focus){L.preventDefault();switch(L.key){case"+":B(g.width/2,g.height/2,-1);break;case"-":B(g.width/2,g.height/2,1);break;case"z":w.marker=null;q();break}}});var r=false;var x=0;var e=false;var s=function(L){if(L.type=="mousedown"){l=L.offsetX;i=L.offsetY}else{let rect=L.target.getBoundingClientRect();if(L.targetTouches.length==1){l=p=L.targetTouches[0].pageX-rect.left;i=n=L.targetTouches[0].pageY-rect.top}else{l=(L.targetTouches[0].pageX+L.targetTouches[1].pageX)/2-rect.left;i=(L.targetTouches[0].pageY+L.targetTouches[1].pageY)/2-rect.top;x=M.norm([L.targetTouches[0].pageX-L.targetTouches[1].pageX,L.targetTouches[0].pageY-L.targetTouches[1].pageY]);r=true;y=false;return}}r=false;y=true;e=false};g.addEventListener("mousedown",s);g.addEventListener("touchstart",s);var m=function(){y=false;r=false};g.addEventListener("mouseup",m);g.addEventListener("touchend",m);g.addEventListener("touchcancel",m);var v=m;g.addEventListener("mouseleave",v);var z=function(O){e=true;if(y){if(O.type=="mousemove"){var N=O.movementX;var L=O.movementY}else{let rect=O.target.getBoundingClientRect();var N=O.targetTouches[0].pageX-rect.left-p;var L=O.targetTouches[0].pageY-rect.top-n;p+=N;n+=L}if(d()){l+=N;i+=L;switch(D){case 0:w.marker.x+=(N/a);w.marker.y+=(L/a);break;case 90:w.marker.y+=(N/a);w.marker.x-=(L/a);break;case -90:w.marker.y-=(N/a);w.marker.x+=(L/a);break}}else{f+=(N/a);C+=(L/a)}q();G();O.stopPropagation();O.preventDefault()}else{if(r&&O.targetTouches.length>1){let pd2=M.norm([O.targetTouches[0].pageX-O.targetTouches[1].pageX,O.targetTouches[0].pageY-O.targetTouches[1].pageY]);if(Math.abs(x-pd2)>10){B(l,i,x-pd2);x=pd2}O.stopPropagation();O.preventDefault()}}};g.addEventListener("mousemove",z);g.addEventListener("touchmove",z);var B=function(N,S,L){const Q=Math.sqrt(2);var P=(L<0?a*Q:a/Q);if(P<0.01||P>100){return}var O=(P-a)/15;clearInterval(b);b=setInterval(R,10);function R(){if(Math.abs(a-P)<1e-10){clearInterval(b)}else{var T=1/(a+O)-1/a;f+=N*T;C+=S*T;a=a+O;q();G()}}};g.addEventListener("wheel",function(L){L.preventDefault();B(L.offsetX,L.offsetY,L.deltaY)});var q=function(){if(K!=null){var L=g.getContext("2d");L.clearRect(0,0,g.width,g.height);switch(D){case 0:L.drawImage(K,f*a,C*a,K.width*a,K.height*a);break;case 90:L.rotate(-Math.PI/2);L.drawImage(K,-K.naturalWidth*a-C*a,f*a,K.width*a,K.height*a);L.rotate(Math.PI/2);break;case -90:L.rotate(Math.PI/2);L.drawImage(K,C*a,-K.naturalHeight*a-f*a,K.width*a,K.height*a);L.rotate(-Math.PI/2);break;case 180:L.rotate(Math.PI);L.drawImage(K,-K.naturalWidth*a-f*a,-K.naturalHeight*a-C*a,K.width*a,K.height*a);L.rotate(-Math.PI);break}}u()};var G=function(){if(w.marker){if(w.marker.more){w.marker.more.draw()}w.marker.draw()}};var j=function(L,O,N){this.x=L;this.y=O;this.color=(N?N:"#3388DD");this.draw=function(){var Q=h(this.x,this.y);var P=g.getContext("2d");P.fillStyle=this.color;P.beginPath();P.arc(Q.x,Q.y-30,12,0,2*Math.PI);P.fill();P.moveTo(Q.x,Q.y-1);P.beginPath();P.lineTo(Q.x-11,Q.y-25);P.lineTo(Q.x+11,Q.y-25);P.lineTo(Q.x,Q.y-1);P.fill();P.fillStyle="#FFFFFF";P.beginPath();P.arc(Q.x,Q.y-30,4,0,2*Math.PI);P.fill()}};var d=function(){if(!w.marker){return false}var N=function(O){return O*O};var L=h(w.marker.x,w.marker.y);return N(L.x-l)+N(L.y-30-i)<12*12};this.repaint()}ImageViewer.styles=".iv_zoom {\nfont-size: 18px;\nheight: 32px;\nwidth: 32px;\npadding-left: 0px;\nline-height: 10px;\nposition: absolute;\n}";var Elevation={hgts:new Array(),pending:new Array(),failures:new Array(),get_elevation:function(o,b,q){var m=function(r,u){let s=""+u;while(s.length<r){s="0"+s}return s};var l=function(r,u){let k=r.indexOf("*");if(k>=0){return r.substring(0,k)+u+r.substring(k+1)}return r+u};var j=function(r,u){return(r<0?0:(r>u?u:r))};var c=function(u,r){if(u.png){let high=u[4*r];let low=u[4*r+1];let a=high*256+low;return a>32767?a-65536:a}return u.getInt16(2*r,false)};var t=function(v,u,r){let x=Math.floor((u-r.bounds[0])*r.pt_per_deg);let y=Math.floor((r.bounds[3]-v)*r.pt_per_deg);let w1=r.width-1,h1=r.height-1;let a11=c(r.data,j(y,h1)*r.width+j(x,w1)),a12=c(r.data,j(y,h1)*r.width+j(x+1,w1)),a21=c(r.data,j(y+1,h1)*r.width+j(x,w1)),a22=c(r.data,j(y+1,h1)*r.width+j(x+1,w1)),dx=(b-r.bounds[0])*r.pt_per_deg-x,dy=(r.bounds[3]-o)*r.pt_per_deg-y,a1=a11+dx*(a12-a11),a2=a21+dx*(a22-a21);return a1+dy*(a2-a1)};var i=function(){let keys=Object.keys(Elevation.hgts),ko=keys[0],n0=Elevation.hgts[ko].n;for(let k=1;k<keys.length;k++){if(Elevation.hgts[keys[k]].n<n0){ko=keys[k];n0=Elevation.hgts[ko].n}}delete Elevation.hgts[ko]};var g=Math.floor(o);var n=Math.floor(b);var f=(g>=0?"N"+m(2,g):"S"+m(2,-g))+(n>=0?"E"+m(3,n):"W"+m(3,-n));var a=NaN;var p=function(v){var w=function(z){let k=z.indexOf("*");if(k>=0){return z.substring(0,k)+f+z.substring(k+1)}return z+f};var r=function(){if(Array.isArray(v)&&v.length>1){p(v.slice(1),f)}else{$.arrayRemove(Elevation.pending,f);Elevation.failures.push(f);if(Elevation.pending.length==0){window.dispatchEvent(new CustomEvent("datapending",{detail:false}))}if(ImageMapViewer.options.edit){Elevation.download(f)}}};var u=function(z){z.bounds=[n,g,n+1,g+1];while(Object.keys(Elevation.hgts).length>Elevation.max_n){i()}Elevation.hgts[f]=z;z.n=Elevation.n++;$.arrayRemove(Elevation.pending,f);if(Elevation.pending.length==0){dispatchEvent(new CustomEvent("datapending",{detail:false}))}if(q){q(t(o,b,z))}};let url=(Array.isArray(v)?v[0]:v);url=w(url,f);if(url.toLowerCase().endsWith("png")){e(url,u,r)}else{h(url,u,r)}};var e=function(u,v,r){let img=document.createElement("img");img.src=u;img.alt="Error";img.onload=function(){var A=document.createElement("canvas");A.style.display="none";A.width=img.naturalWidth;A.height=img.naturalHeight;document.body.appendChild(A);var w=A.getContext("2d");w.drawImage(img,0,0,img.width,img.height);var z=w.getImageData(0,0,img.width,img.height);z.width=img.width;z.height=img.height;z.pt_per_deg=img.width-1;z.data.png=true;document.body.removeChild(A);v(z)};img.onerror=r};var h=function(u,w,r){if(!window.Worker){console.log("No window-worker supported.");r();return}let h=new Worker(Elevation.scriptdir+"srtm.js");h.onmessage=function(z){let imgd=z.data;if(!imgd){r();h.terminate();return}w(imgd);h.terminate()};h.onerror=function(z){r();h.terminate()};var v=function(z){return(z.indexOf("://")>0||z.indexOf("//")===0)};if(!v(u)){let loc=window.location;let path=loc.pathname;let k=path.lastIndexOf("/");if(k>=0&&k!=path.length-1){path=path.substring(0,k+1)}u=loc.protocol+"//"+loc.host+path+u;console.log("url = "+u)}h.postMessage([u])};if(!(f in Elevation.hgts)){if(!Elevation.url||Elevation.failures.includes(f)){throw"ElevationNotAvailable"}if(Elevation.pending.includes(f)){if(q){setTimeout(function(){try{Elevation.get_elevation(o,b,q)}catch(r){}},2000);return a}throw"ElevationPending"}Elevation.pending.push(f);window.dispatchEvent(new CustomEvent("datapending",{detail:true}));p(Elevation.url);if(!q){throw"ElevationPending"}}else{a=t(o,b,Elevation.hgts[f]);if(q){q(a)}}return a},get_elevations:function(a,c){var b=function(f,e,g){if(e.length==0){g(f)}else{let latlon=e.shift();Elevation.get_elevation(latlon[0],latlon[1],function(h){f.push(h);b(f,e,g)})}};b(new Array(),a,c)},resetFailure:function(){$.arrayRemove(Elevation.failures,Elevation.fname);return false},download:function(a){let d=window.open("","","width=600,height=600,menubar=yes,toolbar=yes,scrollbars=yes");Elevation.fname=a;d.document.writeln(Elevation.html_head);d.document.writeln("<h4> Tile "+a+" is missing</h4><dl>");d.document.writeln("<br> Possible actions:<ul>");let url="http://e4ftl01.cr.usgs.gov/MEASURES/SRTMGL1.003/2000.02.11/";url+=a+".SRTMGL1.hgt.zip";d.document.writeln("<li><a href='"+url+"'>Download</a> from SRTM-server, then reset or reload GeoImageViewer.</li>\n");d.document.writeln('<li><a href="https://www.google.com/search?q='+a+'"  target="_blank">Search Google</a></li>\n');d.document.writeln("<li><a onClick='window.opener.Elevation.resetFailure()' href='#'>Reset</a> and ignore</li>");d.document.writeln("</ul>");d.document.writeln(Elevation.html_foot)},html_head:'\n<style>\n.info {\nbox-sizing: border-box;\nmin-width: 200px;\nmax-width: 980px;\nmargin: 0 auto;\npadding: 45px;\n}\n\n@media (max-width: 767px) {\n.info {\npadding: 15px;\n}\n}\n</style>\n<article class="info">',html_foot:"</article>",n:0,max_n:5};let scripts=document.getElementsByTagName("script");let path=scripts[scripts.length-1].src.split("?")[0];Elevation.scriptdir=path.split("/").slice(0,-1).join("/")+"/";"use strict";function Latlng(j,i,b){const f=6371000;const a=0.13/(2*f);var e=this;this.Rc=f+b;this.M_fwd=M.rot(0,Math.PI/2-M.d2r(i),M.d2r(j));this.M_inv=M.trans(this.M_fwd);this.Pc;this.lat=i;this.lon=j;var g=function(l,n,m){let ele=Elevation.get_elevation(n,l)+m;return Latlng.latlng2cart({lat:n,lng:l,ele:ele})};this.getvector=function(l){let p=("ele" in l?Latlng.latlng2cart(l):g(l.lng,l.lat,0));let q=M.mv_mult(e.M_inv,p);q[2]-=e.Rc;let qr=M.norm(q);if(qr==0){qr=1}else{q[2]+=a*qr*qr;qr=M.norm(q)}return[q[1]/qr,q[2]/qr,q[0]/qr]};this.isVisible=function(l,m){let p=g(l,m,0);p=M.v_sub(p,e.Pc);let pa=M.norm(p);if(pa==0){return true}p=M.vs_mult(p,1/pa);for(let k=1;k*100<pa;k++){let px=M.vs_mult(p,k*100);px=M.v_add(px,e.Pc);let b=M.norm(px)-f;let latlng=Latlng.cart2latlng(px);let ele=Elevation.get_elevation(latlng.lat,latlng.lng);if(b<=ele){return false}}return true};this.distance=function(l,m){let p=g(l,m,0);p=M.v_sub(p,e.Pc);return M.norm(p)};this.horizon=function(m,o,l){try{let step=Latlng.searchStep,min=(l?l:Latlng.searchFrom),max=Latlng.searchTo;let latlng=h(m,o,{min:min,step:step,max:max,tol:step});return latlng?latlng:NaN}catch(n){if(n=="ElevationNotAvailable"){return NaN}throw n}};var h=function(n,o,m){let ep=[Math.cos(o)*Math.sin(n),Math.sin(o)*Math.sin(n),-Math.cos(n)];let q=[ep[2],ep[0],ep[1]];q[2]+=e.Rc;let p=M.mv_mult(e.M_fwd,q);p=M.v_sub(p,e.Pc);var l=function(s){let px=M.vs_mult(p,s);px=M.v_add(px,e.Pc);let latlng=Latlng.cart2latlng(px);latlng.ele=Elevation.get_elevation(latlng.lat,latlng.lng);latlng.height=M.norm(px)-a*s*s-f;return latlng};var r=function(s){let latlng=l(s);return latlng.height-latlng.ele};for(let d=m.min;d<=m.max;d+=m.step){let latlng=l(d);let hg=latlng.height-latlng.ele;if(hg<=0){if(d>m.min){d=M.bisection(r,d-m.step,d,m.tol)}latlng=l(d);latlng.dist=d;return latlng}if(latlng.height>Latlng.maxEle){return null}}return null};this.map=function(m,n,l){let min=(l&&l.dist?l.dist:50);let latlng=h(m,n,{min:min,step:50,max:Latlng.maxDist,tol:1});if(latlng){return[latlng.lng,latlng.lat,latlng.dist,latlng.ele]}return null};this.setHfov=null;Elevation.get_elevation(i,j,function(l){e.Pc=g(j,i,b-l)})}Latlng.cart2latlng=function(b){const a=6371000;return{lat:M.r2d(Math.atan2(b[2],Math.sqrt(b[0]*b[0]+b[1]*b[1]))),lng:M.r2d(Math.atan2(b[1],b[0])),ele:M.norm(b)-a}};Latlng.latlng2cart=function(b){const a=6371000;let R=a;if("ele" in b){R+=b.ele}let c=Math.cos(M.d2r(b.lat));return[R*Math.cos(M.d2r(b.lng))*c,R*Math.sin(M.d2r(b.lng))*c,R*Math.sin(M.d2r(b.lat))]};Latlng.searchFrom=100;Latlng.searchTo=20000;Latlng.searchStep=100;Latlng.maxDist=150000;Latlng.maxEle=5000;Latlng.position=function(a){let ele=Camera.getparam(a,"h");let lng=Camera.getparam(a,"d");let lat=Camera.getparam(a,"e");return{lng:lng,lat:lat,ele:ele}};function Camera(g){var f=this;var e=function(n,m){let pd=[4*n[0],3*n[1],2*n[2],n[3]];for(let k=0;k<20;k++){m-=M.polyval(n,m)/M.polyval(pd,m)}return m};var d=function(p,n,B,y,v,t,m,q,z){var C=n/2+m;var A=B/2+q;var u=[y,v,t,1-y-v-t];f.f=(n/2)/z.fwd(p/2);var o=(n<B?n/2:B/2);this.getvector=function(D,E){D=D-C;E=A-E;let rc=Math.sqrt(D*D+E*E);let phi=Math.atan2(E,D);let pc2=[u[0]/(o*o*o),u[1]/(o*o),u[2]/o,u[3],-rc];let r=e(pc2,rc);let theta=z.inv(r/f.f);return[Math.cos(phi)*Math.sin(theta),Math.sin(phi)*Math.sin(theta),-Math.cos(theta)]};this.map=function(D,E){let r=f.f*z.fwd(D);if(r<0){return -1}let rc=r*M.polyval(u,r/o);return[rc*Math.cos(E)+C,A-rc*Math.sin(E)]};f.setHfov=function(D){f.f=(n/2)/z.fwd(D/2)};f.getHfov=function(){return 2*z.inv(n/(2*f.f))};f.getVfov=function(){return 2*z.inv(B/(2*f.f))}};var l=function(u,o,m,q,p){var n=o/2+q;var t=m/2+p;f.f=o/u;this.map=function(v,y){let x=[Math.sin(v)*Math.cos(y),Math.cos(v),Math.sin(v)*Math.sin(y)];v=Math.atan(x[2]/Math.sqrt(x[0]*x[0]+x[1]*x[1]));y=Math.atan2(x[0],x[1]);return[y*f.f+n,t-Math.tan(v)*f.f]};this.getvector=function(v,z){v=v-n;z=t-z;let theta=Math.atan(z/f.f);let phi=v/f.f;return[Math.sin(phi)*Math.cos(theta),Math.sin(theta),-Math.cos(phi)*Math.cos(theta)]};f.setHfov=function(v){f.f=o/v};f.getHfov=function(){return o/f.f};f.getVfov=function(){return 2*Math.atan(m/(2*f.f))}};var j=function(m){let lens=Camera.getparam(m,"f");let hfov=M.d2r(Camera.getparam(m,"v"));let w=Camera.getparam(m,"w");let h=Camera.getparam(m,"h");let hs=Camera.getparam(m,"d");let vs=Camera.getparam(m,"e");let tmap=null,cm=null;switch(lens){case 0:tmap={fwd:function(n){return n>=Math.PI/2?-1:Math.tan(n)},inv:function(n){return Math.atan(n)}};break;case 1:cm=new l(hfov,w,h,hs,vs);break;case 3:tmap={fwd:function(n){return n},inv:function(n){return n}};break;case 5:case 21:tmap={fwd:function(n){return 2*Math.sin(n/2)},inv:function(n){return 2*Math.asin(n/2)}};break;case 10:tmap={fwd:function(n){return 2*Math.tan(n/2)},inv:function(n){return 2*Math.atan(n/2)}};break;case 12:cm=new Latlng(hs,vs,h);f.isVisible=cm.isVisible;f.horizon=cm.horizon;f.distance=cm.distance;break}if(cm==null){let a=Camera.getparam(m,"a");let b=Camera.getparam(m,"b");let c=Camera.getparam(m,"c");cm=new d(hfov,w,h,a,b,c,hs,vs,tmap)}f.getvector=cm.getvector;f.map=function(n,o){let pt=Camera.getPhiTheta(n);return cm.map(pt.theta,pt.phi,o)};f.width=w;f.height=h};j(g)}Camera.getPhiTheta=function(d){return{phi:Math.atan2(d[1],d[0]),theta:Math.atan2(Math.sqrt(d[0]*d[0]+d[1]*d[1]),-d[2])}};Camera.getparam=function(f,e){var d=f.indexOf(e);return d>=0?parseFloat(f.substring(d+1)):0};Camera.getparams=function(e,d){let i=e.indexOf(d);if(i<0){return null}e=e.substring(i+1);i=e.indexOf(" ");if(i>=0){e=e.substring(0,i)}let res=e.split(",");for(i=0;i<res.length;i++){res[i]=parseFloat(res[i])}return res};Camera.setparam=function(e,d,f){let s=d+f+" ";let idx=e.indexOf(d);if(idx<0){return s+e}if(Camera.getparam(e,d)==f){return e}s+=e.substring(0,idx);let camr=e.substring(idx+1);let idx2=camr.indexOf(" ");if(idx2>=0){s+=camr.substring(idx2+1)}return s};"use strict";M.svd=function(a){var l=function(m){return m*m};var f=function(m){return m>=0?1:0};var e=function(m){let eps2=1e-12;let pq=[[1,0],[2,0],[2,1]];let Qr=M.eye(3);let c,s;for(let k=0;k<3;k++){let p=pq[k][0],q=pq[k][1];let n=Math.sqrt(l(m[q][q])+l(m[p][q]));if(n<eps2){c=f(m[q][q]);s=0}else{c=m[q][q]/n;s=m[p][q]/n}let Q=M.eye(3);Q[p][p]=c;Q[q][q]=c;Q[p][q]=-s;Q[q][p]=s;m=M.mm_mult(Q,m);Qr=M.mm_mult(Q,Qr)}return Qr};var d=function(m,t,o){let z=M.vs_mult(M.col(m,t),-1);M.setcol(M.col(m,o),t,m);M.setcol(z,o,m)};var h=function(o,m){let r0=Math.sqrt(M.vv_mult(M.col(o,0),M.col(o,0)));let r1=Math.sqrt(M.vv_mult(M.col(o,1),M.col(o,1)));let r2=Math.sqrt(M.vv_mult(M.col(o,2),M.col(o,2)));if(r0<r1){let r=r0;r0=r1;r1=r;d(o,0,1);d(m,0,1)}if(r0<r2){let r=r0;r0=r2;r2=r;d(o,0,2);d(m,0,2)}if(r1<r2){d(o,1,2);d(m,1,2)}};var g=function(o,m,t){let b=(l(m)<l(o-t)),s,c;if(b){let w=1/Math.sqrt(l(m)+l(o-t));s=w*m;c=w*(o-t)}else{s=Math.sqrt(0.5);c=Math.sqrt(0.5)}return{c:c,s:s}};var j=function(m){let V=M.eye(3);let S=M.mm_mult(M.trans(m),m);let idx=[[0,1],[0,2],[1,2]];for(let i=0;i<5;i++){for(let k=0;k<3;k++){let id=idx[k];let cs=g(S[id[0]][id[0]],S[id[0]][id[1]],S[id[1]][id[1]]);let Q=M.eye(3);Q[id[0]][id[0]]=cs.c;Q[id[0]][id[1]]=-cs.s;Q[id[1]][id[0]]=cs.s;Q[id[1]][id[1]]=cs.c;S=M.mm_mult(M.trans(Q),M.mm_mult(S,Q));V=M.mm_mult(V,Q)}}return V};let V=j(a);let B=M.mm_mult(a,V);h(B,V);let Q=e(B);return{V:M.trans(Q),S:M.diag(M.mm_mult(Q,B)),W:M.trans(V)}};"use strict";M.kabsch=function(c,b,a){if(c.length!=b.length||c[0].length!=b[0].length){console.log("P and Q must be of same size");return}let D=c.length;let N=c[0].length;if(arguments.length>=3&&a.length==N&&M.sum(a)>0){a=M.vs_mult(a,1/M.sum(a))}else{var a=M.vs_mult(M.ones(N),1/N)}let p0=M.trans(new Array(M.mv_mult(c,a)));let q0=M.trans(new Array(M.mv_mult(b,a)));let v1=new Array(M.ones(N));c=M.m_sub(c,M.mm_mult(p0,v1));b=M.m_sub(b,M.mm_mult(q0,v1));let Pdm=M.zeros(D,N);for(let i=0;i<N;i++){M.setcol(M.vs_mult(M.col(c,i),a[i]),i,Pdm)}let C=M.mm_mult(Pdm,M.trans(b));let svd=M.svd(C);svd.W=M.trans(svd.W);let I=M.eye(D);if(M.det(M.mm_mult(svd.V,M.trans(svd.W)))<0){I[D-1][D-1]=-1}let U=M.mm_mult(svd.W,M.mm_mult(I,M.trans(svd.V)));let r=M.trans(M.m_sub(q0,M.mm_mult(U,p0)))[0];let Diff=M.m_sub(M.mm_mult(U,c),b);let lrms=0;for(let i=0;i<N;i++){lrms+=a[i]*M.vv_mult(M.col(Diff,i),M.col(Diff,i))}lrms=Math.sqrt(lrms);return{U:U,r:r,lrms:lrms}};"use strict";M.lmsolve=function(m,t,u,r,v){var b=t.length;var o=u.length;if(r.length!=o){throw"DataError"}var n=u[0].length;var l=r[0].length;const g=0.0001;const q=50;var d=function(f){let y=Array();for(let k=0;k<f.length;k++){y[k]=f[k]*f[k]}return y};var a=function(w,f){let dx=M.v_sub(w,f);for(let k=0;k<w.length;k++){if(w[k]!=0){dx[k]/=w[k]}}return Math.sqrt(M.sum(d(dx))/dx.length)};var e=function(w,x){let d2=M.zeros(l,0);let mx=0,nx=0;for(let j=0;j<o;j++){let y=d(M.v_sub(w(x,u[j]),r[j]));let ex=Math.sqrt(M.sum(y)/l);if(ex>mx){mx=ex;nx=j}d2=M.v_add(d2,y)}let s=0;for(let j=0;j<l;j++){s+=d2[j];d2[j]=Math.sqrt(d2[j]/o)}d2.sq=s;d2.s=Math.sqrt(s/(o*l));d2.mx=mx;d2.nx=nx;return d2};var c=function(A,B,z,w){let h=1e-8;if(B[z]!=0){h=h*B[z]}let pd=M.zeros(B.length,0);pd[z]=h;let yd=M.v_sub(A(M.v_add(B,pd),w),A(M.v_sub(B,pd),w));return M.vs_mult(yd,1/(2*h))};let delta=e(m,t);if(delta.s<v){return t}let err=delta.sq;let F=M.zeros(o*l,0);let J=M.zeros(o*l,b);let lambda=1;let msg="Exceeded "+q+" iterations.";for(let it=0;it<q;it++){for(let j=0;j<o;j++){let y=m(t,u[j]);for(let k=0;k<l;k++){let idx=k*o+j;F[idx]=y[k]-r[j][k]}for(let i=0;i<b;i++){let yd=c(m,t,i,u[j]);for(let k=0;k<l;k++){J[k*o+j][i]=yd[k]}}}let Jt=M.trans(J);let JtJ=M.mm_mult(Jt,J);let Mt=M.mm_add(JtJ,M.diag(M.vs_mult(M.diag(JtJ),lambda)));if(M.det(Mt)==0){console.log("Equations unsolvable. Use different initial values.");throw"Unsolvable"}let s=M.linsolve(Mt,M.mv_mult(Jt,F));let p=M.v_sub(t,s);delta=e(m,p);let dc=a(p,t);if(delta.s<v){msg="Average error smaller than "+v;break}if(dc<g){msg="Relative change smaller than "+g;break}if(delta.sq>err){lambda*=10}else{lambda/=10;t=p;err=delta.sq}}delta=e(m,t);console.log(msg);t.s=delta.s;t.nx=delta.nx;t.mx=delta.mx;return t};"use strict";M.insideTriangle=function(d,g,f){let A=[[f[1].x-f[0].x,f[2].x-f[0].x],[f[1].y-f[0].y,f[2].y-f[0].y]];let b=[d-f[0].x,g-f[0].y];let r=M.linsolve(A,b);if(r==null||r[0]<0||r[1]<0||r[0]+r[1]>1){return null}return r};M.Delaunay=function(E){const g=false;var o=function(F){return E[F].x.toFixed(1)+"/"+E[F].y.toFixed(1)};var f=[];var y=function(F){return F*F};var m=function(H,G){this.v=(H<G?[H,G]:[G,H]);this.t=0;var F=this;this.length=function(){return Math.sqrt(y(E[H].x-E[G].x)+y(E[H].y-E[G].y))};this.joined=function(I){return F.v[0]==I.v[0]||F.v[0]==I.v[1]||F.v[1]==I.v[0]||F.v[1]==I.v[1]};this.totriangle=function(I){for(let H=0;H<2;H++){for(let k=0;k<2;k++){if(I.v[H]==F.v[k]){return new m(I.v[(H+1)%2],F.v[(k+1)%2])}}}return null};this.equals=function(I){return I&&I.v[0]==F.v[0]&&I.v[1]==F.v[1]}};var B=function(J,H,G){var F=this;this.area=function(){let J=F.v[0],H=F.v[1],G=F.v[2];return Math.abs((E[H].x-E[J].x)*(E[H].y-E[J].y)-(E[G].x-E[J].x)*(E[G].y-E[J].y))/2};this.contains=function(K){let J=F.v[0],H=F.v[1],G=F.v[2];return M.insideTriangle(E[K].x,E[K].y,[E[J],E[H],E[G]])!=null};this.overlaps=function(K){for(let J=0;J<3;J++){for(let G=0;G<3;G++){if(d(F.v[J],F.v[(J+1)%3],K.v[G],K.v[(G+1)%3])){return true}}}return false};this.flip=function(K,L){for(let J=0;J<3;J++){if(F.v[J]==K){F.v[J]=L;break}}I()};this.equals=function(K){return K&&K.v[0]==F.v[0]&&K.v[1]==F.v[1]&&K.v[2]==F.v[2]};var I=function(){F.v.sort(function(L,K){return L-K})};this.v=[J,H,G];I();if(g){console.log("Created triangle "+F.v)}};var C=function(H,G,F){let n1,n2,n3;n3=n1=n2=0;for(let i=0;i<2;i++){for(let k=0;k<2;k++){if(H.v[i]==G.v[k]){n1=H.v[i]}if(G.v[i]==F.v[k]){n2=G.v[i]}if(F.v[i]==H.v[k]){n3=F.v[i]}}}return new B(n1,n2,n3)};var s=function(F){for(let i=0;i<E.length;i++){if(F.v[0]!=i&&F.v[1]!=i&&F.v[2]!=i&&F.contains(i)){return false}}return true};var w=function(F){for(let i=0;i<f.length;i++){if(F.equals(f[i])){return true}}return false};var z=function(){var F=[];for(let i=0;i<E.length;i++){for(let j=i+1;j<E.length;j++){if(g){console.log("Checking "+i+"/"+j+"   :"+o(i)+" <-> "+o(j))}let k=0;for(k=0;k<F.length;k++){let e=F[k];if(d(i,j,e.v[0],e.v[1])){break}}if(k==F.length){for(k=0;k<E.length;k++){if(i!=k&&j!=k&&h(i,k,j)){break}}if(k==E.length){F.push(new m(i,j));if(g){console.log("Success, added "+(F.length-1))}}else{if(g){console.log("Failed: Inline "+k+": "+o(k))}}}else{if(g){console.log("Failed: intersects "+k)}}}}if(g){console.log("Created "+F.length+" edges.")}F.sort(function(I,H){return I.length()-H.length()});var G=null;while(F.length>0){let e1=F[0],e2=null,e3=null;let k,j;for(k=1;k<F.length;k++){e2=F[k];let tmp=e1.totriangle(e2);if(!tmp){continue}for(j=1;j<F.length;j++){e3=F[j];if(e3.equals(tmp)){G=C(e1,e2,e3);if(!w(G)&&s(G)){break}}}if(j!=F.length){break}}if(k!=F.length){if(g){console.log("Adding triangle "+G.v)}f.push(G);if(e1.t++>0){$.arrayRemove(F,e1)}if(e2.t++>0){$.arrayRemove(F,e2)}if(e3.t++>0){$.arrayRemove(F,e3)}}else{if(e1.t>0){$.arrayRemove(F,e1)}else{console.log("Delaunay initialization: Could not assign to triangle.");throw"DataError"}}}};var u=function(G,F){return y(E[G].x-E[F].x)+y(E[G].y-E[F].y)};var n=function(){let flips=0;for(let i=0;i<f.length;i++){let a=f[i];for(let k=i+1;k<f.length;k++){let b=f[k];let n0,n1,n2,n3;n0=n1=n2=n3=-1;for(let j=0;j<3;j++){if(a.v[j]==b.v[0]||a.v[j]==b.v[1]||a.v[j]==b.v[2]){if(n1==-1){n1=a.v[j]}else{n2=a.v[j]}}}if(n1!=-1&&n2!=-1){for(let j=0;j<3;j++){if(a.v[j]!=n1&&a.v[j]!=n2){n0=a.v[j]}if(b.v[j]!=n1&&b.v[j]!=n2){n3=b.v[j]}}if(u(n1,n2)>u(n0,n3)&&d(n1,n2,n0,n3)){b.flip(n2,n0);a.flip(n1,n3);flips++}}}}return flips};var x=function(I,H,G,F){let A=[[E[I].y-E[H].y,E[H].x-E[I].x],[E[G].y-E[F].y,E[F].x-E[G].x]];let b=[E[I].y*E[H].x-E[I].x*E[H].y,E[G].y*E[F].x-E[G].x*E[F].y];return M.linsolve(A,b)};var d=function(I,H,G,F){let p=x(I,H,G,F);if(p==null){return false}return D(p,I,H)&&D(p,G,F)};var l=function(G,H,F){let eps=1e-8;if(H==F){return G==H}else{if(H<F){return G>H+eps&&G<F-eps}else{return G<H-eps&&G>F+eps}}};var D=function(H,G,F){return l(H[0],E[G].x,E[F].x)&&l(H[1],E[G].y,E[F].y)};var h=function(H,G,F){let dy=E[F].y-E[H].y,dx=E[F].x-E[H].x,alpha=0;if(dy==0){alpha=(E[G].x-E[H].x)/dx;return alpha>0&&alpha<1&&Math.abs(E[F].y-E[G].y)<0.01}else{alpha=(E[G].y-E[H].y)/dy;return alpha>0&&alpha<1&&Math.abs((E[G].x-E[H].x)-alpha*dx)<0.01}};z();this.triangulate=function(F){while(F-->0&&n()>0){}return f}};M.morpher=function(h,l){var g=new M.Delaunay(l).triangulate(150);var d=function(m,o,n){for(let k=0;k<g.length;k++){let t=g[k],c=[n[t.v[0]],n[t.v[1]],n[t.v[2]]];let r=M.insideTriangle(m,o,c);if(r!=null){return{r:r,k:k}}}return null};var f=function(n,o,m){let t=g[m],v=[o[t.v[0]],o[t.v[1]],o[t.v[2]]];return{x:v[0].x+n[0]*(v[1].x-v[0].x)+n[1]*(v[2].x-v[0].x),y:v[0].y+n[0]*(v[1].y-v[0].y)+n[1]*(v[2].y-v[0].y)}};this.morph=function(m,n){let q=d(m,n,h);if(q==null){console.log("morph: q = 0 for "+m+"/"+n)}return(q==null?null:f(q.r,l,q.k))};this.invmorph=function(m,n){let q=d(m,n,l);if(q==null){console.log("invmorph: q = 0 for "+m+"/"+n)}return(q==null?null:f(q.r,h,q.k))}};"use strict";var Remap=function(c,d){var a=this;var b=function(e){let cam=new Camera(e.cam);let p=M.d2r(Camera.getparam(e.cam,"p")),y=M.d2r(Camera.getparam(e.cam,"y")),r=M.d2r(Camera.getparam(e.cam,"r"));let M_fwd=M.rot(p,y,r);let M_inv=M.trans(M_fwd);let sel=Camera.getparams(e.cam,"C");if(!sel){sel=[0,cam.width,0,cam.height]}let rot=("rot" in e?e.rot:0);return{cam:cam,rot:rot,M_fwd:M_fwd,M_inv:M_inv,sel:sel}};c=b(c);d=b(d);this.remap=function(e,f){let q=c.cam.getvector(e+c.sel[0],f+c.sel[2]);if(c.rot==90){q=[-q[1],q[0],q[2]]}else{if(c.rot==-90){q=[q[1],-q[0],q[2]]}}q=M.mv_mult(c.M_inv,q);q=M.mv_mult(d.M_fwd,q);if(d.rot==90){q=[q[1],-q[0],q[2]]}else{if(d.rot==-90){q=[-q[1],q[0],q[2]]}}let r=d.cam.map(q);r[0]-=d.sel[0];r[1]-=d.sel[2];return r};this.invremap=function(e,f){let q=d.cam.getvector(e+d.sel[0],f+d.sel[2]);if(d.rot==90){q=[-q[1],q[0],q[2]]}else{if(d.rot==-90){q=[q[1],-q[0],q[2]]}}q=M.mv_mult(d.M_inv,q);q=M.mv_mult(c.M_fwd,q);if(c.rot==90){q=[q[1],-q[0],q[2]]}else{if(c.rot==-90){q=[-q[1],q[0],q[2]]}}let r=c.cam.map(q);r[0]-=c.sel[0];r[1]-=c.sel[2];return r}};"use strict";function Geoimg(i){var s=this;this.setCamera=function(f){s.cam=new Camera(f);let p=M.d2r(Camera.getparam(f,"p")),y=M.d2r(Camera.getparam(f,"y")),r=M.d2r(Camera.getparam(f,"r"));o=M.rot(p,y,r);u=M.trans(o);s.isAligned=(p!=0||y!=0||r!=0)};var l=Camera.setparam(i.pos,"f",12);this.latlon=new Camera(l);var o,u,e=null;s.setCamera(i.cam);var b=Camera.getparams(i.cam,"C");if(!b){b=[0,s.cam.width,0,s.cam.height]}this.rot=("rot" in i?i.rot:0);this.imagecoords=function(f){let p=s.latlon.getvector(f);let q=M.mv_mult(o,p);if(s.rot==90){let q1=q[1];q[1]=-q[0];q[0]=q1}else{if(s.rot==-90){let q1=q[1];q[1]=q[0];q[0]=-q1}}let r=s.cam.map(q);r[0]-=b[0];r[1]-=b[2];if(e){let xy=e.morph(r[0],r[1]);r[0]=xy.x;r[1]=xy.y}return r};var m=function(f,w){if(e){let xy=e.invmorph(f,w);f=xy.x;w=xy.y}return s.cam.getvector(f+b[0],w+b[2])};var n=function(f,w){let q=m(f,w);if(s.rot==90){let q1=q[1];q[1]=q[0];q[0]=-q1}else{if(s.rot==-90){let q1=q[1];q[1]=-q[0];q[0]=q1}}return M.mv_mult(u,q)};this.geocoords=function(f,z,w){let p=n(f,z);return s.latlon.map(p,w)};this.yawfov=function(){let p1,p2,ws=b[1]-b[0],hs=b[3]-b[2];switch(s.rot){case 0:p1=n(0,hs/2),p2=n(ws-1,hs/2);break;case 90:p1=n(ws/2,0),p2=n(ws/2,hs-1);break;case -90:p1=n(ws/2,hs-1),p2=n(ws/2,0);break}let y1=Math.PI/2-Math.atan2(-p1[2],p1[0]),y2=Math.PI/2-Math.atan2(-p2[2],p2[0]);return{y:M.r2d((y2+y1)/2),v:M.r2d(y2-y1)}};this.horizon=function(f){switch(s.rot){case 0:var B=s.cam.height-1,w=s.cam.height/2;var z=m(f,B);break;case 90:var B=f,w=s.cam.width/2;f=0;var z=m(f,B);z=[-z[1],z[0],z[2]];break;case -90:var B=f,w=s.cam.width/2;f=s.cam.width-1;var z=m(f,B);z=[z[1],-z[0],z[2]];break}let p=M.mv_mult(u,z);let pt=Camera.getPhiTheta(p);var A=s.latlon.horizon(pt.theta,pt.phi);if(A!==A){let px=s.rot==0?s.cam.height-1:(s.rot==90?0:s.cam.width-1);return{px:px,lng:s.latlon.lon,lat:s.latlon.lat}}while(w>1){switch(s.rot){case 0:z=m(f,B-w);break;case 90:z=m(f+w,B);z=[-z[1],z[0],z[2]];break;case -90:z=m(f-w,B);z=[z[1],-z[0],z[2]];break}let p=M.mv_mult(u,z);let pt=Camera.getPhiTheta(p);let d=s.latlon.horizon(pt.theta,pt.phi,A.dist);if(!(d!==d)){switch(s.rot){case 0:B-=w;break;case 90:f+=w;break;case -90:f-=w;break}A=d}w/=2}A.px=(s.rot==0?B:f);return A};this.inside=function(f){return f[0]>=0&&f[0]<b[1]-b[0]&&f[1]>=0&&f[1]<b[3]-b[2]};var a=function(B,A){let sq=function(C){return C*C};let t=Math.atan2(A[0],A[2]);let c=Math.sqrt(sq(A[0])+sq(A[2]));if(c==0||Math.abs(B[0]/c)>1){throw"Unsolvable"}var x=Math.asin(B[0]/c);var f=x-t;var z=Math.atan2(A[1],c*Math.cos(f+t));var w=Math.atan2(B[1],B[2])-z;if(Math.abs(w)>Math.PI/2){x=Math.PI-x;f=x-t;z=Math.atan2(A[1],c*Math.cos(f+t));w=Math.atan2(B[1],B[2])-z}if(f>Math.PI){f-=2*Math.PI}if(f<-Math.PI){f+=2*Math.PI}return M.rot(w,f,0)};this.optimize=function(w){let np=w.length;let Q=M.zeros(3,2*np),P=M.zeros(3,2*np);for(let k=0;k<np;k++){let c=w[k];let v=s.latlon.getvector(c);M.setcol(v,k,Q);M.setcol(M.vs_mult(v,-1),np+k,Q);v=s.cam.getvector(c.x,c.y);M.setcol(v,k,P);M.setcol(M.vs_mult(v,-1),np+k,P)}if(np==1){try{let M1=a(M.col(P,0),M.col(Q,0));let pyr=M.rangles(M1);return{p:M.r2d(pyr.a),y:M.r2d(pyr.b),r:M.r2d(pyr.c),lrms:0,err:[0]}}catch(f){console.log("Unsolveable. Using Kabsch."+f)}}let r=M.kabsch(Q,P);let pyr=M.rangles(r.U);let Qt=M.mm_mult(r.U,Q);let f=new Array();for(let k=0;k<np;k++){let x1=s.cam.map(M.col(Qt,k)),x2=s.cam.map(M.col(P,k));f[k]=M.norm(M.v_sub(x1,x2))}return{p:M.r2d(pyr.a),y:M.r2d(pyr.b),r:M.r2d(pyr.c)+s.rot,lrms:M.r2d(r.lrms),err:f}};this.visibleTrack=function(f){let ontrack=false;let s_img=new Array(),si,s_map=new Array(),sm;for(let k=0;k<f.length;k++){let t=f[k];let ele=Elevation.get_elevation(t.lat,t.lng);if(f.ele&&"ele" in t){t.ele=Math.max(ele,t.ele)}else{t.ele=ele}let xy=s.imagecoords(t);if(s.inside(xy)&&s.latlon.isVisible(t.lng,t.lat)){if(!ontrack){si=[xy[0],xy[1]];sm=[t];ontrack=true}else{si.push(xy[0]);si.push(xy[1]);sm.push(t)}}else{if(ontrack){ontrack=false;s_img.push(si);s_map.push(sm)}}}if(ontrack){s_img.push(si);s_map.push(sm)}return{img:s_img,map:s_map}};this.clone=function(){let c=new Geoimg(i);c.rot=s.rot;return c};var g=function(x,w){if(w=="ElevationPending"){setTimeout(x,2000)}else{console.log("Elevation not available "+w)}};var h=false;if("cpts" in i&&!ImageMapViewer.options.edit){console.log("Creating morpher cpts = "+i.cpts);let ws=b[1]-b[0],hs=b[3]-b[2];var j=function(){try{let frame=[{x:-ws,y:-hs},{x:2*ws,y:-hs},{x:-ws,y:2*hs},{x:2*ws,y:2*hs}],src=frame.slice(),dst=frame.slice();let rp=("src" in i?new Remap({cam:i.src,rot:s.rot},i):null);for(let k=0;k<i.cpts.length;k++){let c=i.cpts[k],xy=s.imagecoords(c);src.push({x:xy[0],y:xy[1]});if(rp){let xy=rp.remap(c.x,c.y);c={x:xy[0],y:xy[1]}}dst.push(c)}e=new M.morpher(src,dst);h=true}catch(f){g(j,f)}};j()}else{h=true}this.getWidth=function(){return b[1]-b[0]};this.depthimage=function(R,C,K){var E=Math.round(b[1]-b[0]),O=Math.round(b[3]-b[2]);var J=1,G=1;if(R&&R>0){J=R/E;E=R;if(C==0){G=J;O=Math.round(O*G)}}if(C&&C>0){G=C/O;O=C;if(R==0){J=G;E=Math.round(E*J)}}var D=document.createElement("canvas");D.style.display="none";D.width=E;D.height=O;document.body.appendChild(D);var A=D.getContext("2d");var z=A.createImageData(E,O);for(let k=0;k<z.data.length;k+=4){z.data[k+3]=255}const I=256*256*256-1;K.document.writeln("<br>Please wait. The rendered image will appear below.For progress information open the webconsole.<br>");var B=function(){A.putImageData(z,0,0);let imgAsDataURL=D.toDataURL("image/png");document.body.removeChild(D);K.document.write("<img src="+imgAsDataURL+">");K.document.writeln("<br>Use Right-Click to save the image.<br>")};var L,H,f,F;var N=function(){if(F!=I){try{var x=s.geocoords(L/J,H/G,{dist:Math.floor(F/10)})}catch(w){if(w=="ElevationPending"){console.log("Loading Elevation data.");setTimeout(f,3000)}else{document.body.removeChild(D);K.document.writeln("<br>Image creation failed: "+w)}return false}if(x&&x.length>=3){F=Math.round(x[2]*10)}else{F=I}}let idx=4*(H*E+L);let dd=F;z.data[idx]=Math.floor(dd/(256*256));dd-=z.data[idx]*256*256;z.data[idx+1]=Math.floor(dd/256);dd-=z.data[idx+1]*256;z.data[idx+2]=dd;return true};switch(s.rot){case 0:L=0;H=O-1;f=function(){for(;L<E;L++){console.log("Col "+L+" / "+E);F=20;for(H=O-1;H>=0;H--){if(!N()){return}}}B()};break;case 90:L=0;H=0;f=function(){for(;H<O;H++){console.log("Row "+H+" / "+O);F=20;for(L=0;L<E;L++){if(!N()){return}}}B()};break;case -90:L=E-1;H=0;f=function(){for(;H<O;H++){console.log("Row "+H+" / "+O);F=20;for(L=E-1;L>=0;L--){if(!N()){return}}}B()};break}f()}};"use strict";function Geoimg2(D){var o=function(E){let R=h+E.ele;let c=Math.cos(E.lat);let xy=new Array();xy[0]=R*Math.cos(E.lon)*c;xy[1]=R*Math.sin(E.lon)*c;xy[2]=R*Math.sin(E.lat);return xy};var a=function(E){let p=o(E);let q=M.mv_mult(v,p);q[2]-=z;let qr=M.norm(q);if(qr==0){qr=1}else{q[2]+=i*qr*qr;qr=M.norm(q)}return[q[1]/qr,q[2]/qr,q[0]/qr]};var u=function(E){var F=function(G,H,I){return(G<H?H:(G>I?I:G))};let p=a(E);let q=M.mv_mult(g,p);if(s.rot==90){let q1=q[1];q[1]=-q[0];q[0]=q1}else{if(s.rot==-90){let q1=q[1];q[1]=q[0];q[0]=-q1}}let r=s.cam.map(q);r[0]=F(r[0]-w[0],-10,w[1]-w[0]+10);r[1]=F(r[1]-w[2],-10,w[3]-w[2]+10);if(e){let xy=e.morph(r[0],r[1]);r[0]=xy.x;r[1]=xy.y}return r};this.imagecoords=function(G){if("ele" in G){let x={lon:M.d2r(G.lng),lat:M.d2r(G.lat),ele:G.ele};let xy=u(x);xy.dist=B(x);try{xy.vis=C(xy[0],xy[1])>=xy.dist}catch(F){}return xy}let lon=M.d2r(G.lng);let lat=M.d2r(G.lat);var E=function(H){let x={lon:lon,lat:lat,ele:H};let d1=B(x);let xy=u(x);let d2=C(xy[0],xy[1]);return d2-d1};let ele=M.bisection(E,-50,Latlng.maxEle,0.1);let r=u({lon:lon,lat:lat,ele:ele});r.vis=(Math.abs(E(ele-0.1))<10);if(r.vis){r.ele=ele}r.dist=(r.vis?C(r[0],r[1]):B({lon:lon,lat:lat,ele:ele}));return r};var B=function(E){let c=o(E);return M.norm(M.v_sub(b,c))};var C=function(E,H){var G=function(I,J){return(I<0?0:(I>J?J:I))};if(e){let xy=e.invmorph(E,H);E=xy.x;H=xy.y}if(!A){throw (f?"ElevationPending":"ElevationNotAvailable")}var F=function(J,I){let r=0;for(let k=0;k<3;k++){r=r*256+J[4*I+k]}return r};let w1=A.width-1,h1=A.height-1;E=E*A.width/(w[1]-w[0]);H=H*A.height/(w[3]-w[2]);let xf=Math.floor(E),yf=Math.floor(H);let a11=F(A.data,G(yf,h1)*A.width+G(xf,w1)),a12=F(A.data,G(yf,h1)*A.width+G(xf+1,w1)),a21=F(A.data,G(yf+1,h1)*A.width+G(xf,w1)),a22=F(A.data,G(yf+1,h1)*A.width+G(xf+1,w1)),dx=E-xf,dy=H-yf;if(a11==n||a12==n||a21==n||a22==n){return n}let a1=a11+dx*(a12-a11),a2=a21+dx*(a22-a21),r=(a1+dy*(a2-a1));return r/10};var j=function(E,F){if(e){let xy=e.invmorph(E,F);E=xy.x;F=xy.y}let q=s.cam.getvector(E+w[0],F+w[2]);if(s.rot==90){let q1=q[1];q[1]=q[0];q[0]=-q1}else{if(s.rot==-90){let q1=q[1];q[1]=-q[0];q[0]=q1}}return M.mv_mult(m,q)};this.geocoords=function(E,F){let p=j(E,F);let d=C(E,F);if(d==n){return null}let q=[p[2],p[0],p[1]];q[2]+=z;p=M.mv_mult(l,q);p=M.v_sub(p,b);let pr=M.norm(p);if(pr==0){pr=1}p=M.vs_mult(p,d/pr);p=M.v_add(p,b);let height=M.norm(p)-i*d*d-h;let lnglat=Latlng.cart2latlng(p);return[lnglat.lng,lnglat.lat,d,height]};this.yawfov=function(){let p1,p2,ws=w[1]-w[0],hs=w[3]-w[2];switch(s.rot){case 0:p1=j(0,hs/2),p2=j(ws-1,hs/2);break;case 90:p1=j(ws/2,0),p2=j(ws/2,hs-1);break;case -90:p1=j(ws/2,hs-1),p2=j(ws/2,0);break}let y1=Math.PI/2-Math.atan2(-p1[2],p1[0]),y2=Math.PI/2-Math.atan2(-p2[2],p2[0]);return{y:M.r2d((y2+y1)/2),v:M.r2d(y2-y1)}};this.horizon=function(E){let ws=w[1]-w[0],hs=w[3]-w[2],y,step,d,ll,scale=0;switch(s.rot){case 0:y=hs-1;step=hs/2;d=C(E,y);if(d>=s.searchTo||d==n){return{px:y,dist:0,lng:s.lon,lat:s.lat}}while(step>1){d=C(E,y-step);if(d<s.searchTo){y-=step}step/=2}if(s.searchTo<n){scale=Math.round(hs/A.height)+2}ll=s.geocoords(E,y+scale);return{px:y,lng:ll[0],lat:ll[1]};case 90:y=E;step=ws/2;E=0;d=C(E,y);if(d>=s.searchTo||d==n){return{px:0,dist:0,lng:s.lon,lat:s.lat}}while(step>1){d=C(E+step,y);if(d<s.searchTo){E+=step}step/=2}if(s.searchTo<n){scale=Math.round(ws/A.width)+2}ll=s.geocoords(E-scale,y);return{px:E,lng:ll[0],lat:ll[1]};case -90:y=E;step=ws/2;E=ws-1;d=C(E,y);if(d>=s.searchTo||d==n){return{px:ws-1,dist:0,lng:s.lon,lat:s.lat}}while(step>1){d=C(E-step,y);if(d<s.searchTo){E-=step}step/=2}if(s.searchTo<n){scale=Math.round(ws/A.width)+2}ll=s.geocoords(E+scale,y);return{px:E,lng:ll[0],lat:ll[1]}}};this.inside=function(E){return E[0]>=0&&E[0]<w[1]-w[0]&&E[1]>=0&&E[1]<w[3]-w[2]};this.visibleTrack=function(E){let ontrack=false;let s_img=new Array(),si,s_map=new Array(),sm;for(let k=0;k<E.length;k++){let t=E[k];let xy=s.imagecoords({lat:t.lat,lng:t.lng});if(E.ele&&"ele" in t){if("ele" in xy){t.ele=Math.max(t.ele,xy.ele)}xy=s.imagecoords(t)}if(s.inside(xy)&&xy.vis){if(!ontrack){si=[xy[0],xy[1]];sm=[t];ontrack=true}else{si.push(xy[0]);si.push(xy[1]);sm.push(t)}}else{if(ontrack){ontrack=false;s_img.push(si);s_map.push(sm)}}}if(ontrack){s_img.push(si);s_map.push(sm)}return{img:s_img,map:s_map}};this.clone=function(){let c=new Geoimg2(D);c.rot=s.rot;return c};const h=6371000;const i=0.13/(2*h);const n=256*256*256-1;this.searchTo=n;var s=this;this.lat=M.d2r(Camera.getparam(D.pos,"e"));this.lon=M.d2r(Camera.getparam(D.pos,"d"));this.ele=Camera.getparam(D.pos,"h");var l=M.rot(0,Math.PI/2-s.lat,s.lon);var v=M.trans(l);var z=h+s.ele;var b=o(s);var e=null;this.cam=new Camera(D.cam);var g,m;let p=M.d2r(Camera.getparam(D.cam,"p")),y=M.d2r(Camera.getparam(D.cam,"y")),r=M.d2r(Camera.getparam(D.cam,"r"));g=M.rot(p,y,r);m=M.trans(g);s.isAligned=(p!=0||y!=0||r!=0);var w=Camera.getparams(D.cam,"C");if(!w){w=[0,s.cam.width,0,s.cam.height]}this.rot=("rot" in D?D.rot:0);var f=true;var A=null;let d=document.createElement("img");d.src=D.depth;d.alt="Error";d.onload=function(){var F=document.createElement("canvas");F.style.display="none";F.width=d.naturalWidth;F.height=d.naturalHeight;document.body.appendChild(F);var E=F.getContext("2d");E.drawImage(d,0,0,d.width,d.height);A=E.getImageData(0,0,d.width,d.height);document.body.removeChild(F);f=false};d.onerror=function(){alert("Failed to download Elevation data from: "+D.depth);f=false};if("cpts" in D&&!ImageMapViewer.options.edit){let ws=w[1]-w[0],hs=w[3]-w[2];let frame=[{x:-ws,y:-hs},{x:2*ws,y:-hs},{x:-ws,y:2*hs},{x:2*ws,y:2*hs}],src=frame.slice(),dst=frame.slice();let rp=("src" in D?new Remap({cam:D.src,rot:s.rot},D):null);for(let k=0;k<D.cpts.length;k++){let c=D.cpts[k],xy=s.imagecoords(c);src.push({x:xy[0],y:xy[1]});if(rp){let xy=rp.remap(c.x,c.y);c={x:xy[0],y:xy[1]}}dst.push(c)}e=new M.morpher(src,dst)}};"use strict";function Ddmenu(c,a){var b=document.getElementById(c);var n=this;if(!Ddmenu.inited){$.addStyle(Ddmenu.style);Ddmenu.inited=true}function f(o){$.addStyle("#"+c+" "+o)}if(a){if(Array.isArray(a)){a.forEach(f)}else{f(a)}}b.classList.add("Ddmenu");var e=null;this.setMenu=function(p,o){while(b.firstChild){b.removeChild(b.firstChild)}b.innerHTML="<div href='#' class='Dd_title'> <center><h3>"+p.text+"</h3></center></div><table class='Dd_table'></table>";e=o;var q=b.getElementsByClassName("Dd_title")[0];if(p.onclick){if(p.ctrl){let y=m(p.ctrl,function(r){p.onclick(r)});q.appendChild(y);q.onclick=function(){if(!g){y.click()}}}else{q.onclick=function(){if(!g){p.onclick()}}}}if(p||o){q.addEventListener("touchstart",function(r){if(!d){g=true}else{g=false}});q.addEventListener("mouseover",function(r){if(o){l()}q.style.backgroundColor="#BBBBBB"});b.addEventListener("mouseleave",function(r){if(o){h()}q.style.backgroundColor="#FFFFFF";g=false})}};var d=false;var g=false;var h=function(){var o=b.getElementsByClassName("Dd_table")[0];var p=b.getElementsByClassName("Dd_title")[0];for(let k=o.rows.length-1;k>=0;k--){o.deleteRow(k)}while(o.firstChild){o.removeChild(o.firstChild)}o.style.display="none";d=false;p.style.backgroundColor="#FFFFFF"};var l=function(){if(d||!e){return}let menulist2=e;if(typeof e=="function"){menulist2=e()}i(menulist2);var o=b.getElementsByClassName("Dd_table")[0];o.style.display="block";d=true};var m=function(p,o){let x=document.createElement("input");x.setAttribute("type",p);x.style.display="none";x.addEventListener("change",o,false);return x};var i=function(p){let max_nr=18;let nc=(p.nc?p.nc:Math.ceil(p.length/max_nr)),nr=(p.nr?p.nr:(p.length>max_nr?max_nr:p.length));var q=b.getElementsByClassName("Dd_table")[0];for(let k=0;k<nr;k++){let row=q.insertRow();for(let j=0;j<nc;j++){let idx=j*nr+k;if(idx>=p.length){continue}let x=p[idx];if(!x.onclick){let o=document.createElement("a");o.appendChild(document.createTextNode(x.text));o.style.textAlign="left";row.insertCell().appendChild(o);continue}var o=document.createElement("a");o.setAttribute("href","#");if(x.ctrl){let y=m(x.ctrl,x.onclick);q.appendChild(y);o.onclick=function(){y.click();h()}}else{o.onclick=function(){x.onclick();h()}}if(x.onhover){o.addEventListener("mouseover",function(r){let rect=this.getBoundingClientRect();x.onhover(true,rect)});o.addEventListener("mouseleave",function(r){let rect=this.getBoundingClientRect();x.onhover(false,rect)})}o.appendChild(document.createTextNode(x.text));row.insertCell().appendChild(o)}}};b.menu=this}Ddmenu.style=".Ddmenu {\nposition: absolute;\ntop: 12px;\n}\n.Dd_title, .Dd_table{\nposition: absolute;\nborder-style: solid;\nborder-color: #888888;\nborder-radius: 5px;\nborder-width: 2px;\nbackground-color: #FFFFFF;\ncolor: #777777;\n}\n.Dd_title {\nheight: 45px;\nmin-width: 100px;\npadding-right: 10px;\npadding-left: 10px;\ntop: 0px;\nright: 0px;\ndisplay: flex;\njustify-content: center;\nalign-items: center;\nwhite-space: nowrap;\n}\n.Dd_title a{\ntext-decoration: none;\ndisplay: block;\n}\n.Dd_table {\ndisplay: none;\ntop: 49px;\nright: 0px;\nborder-collapse: collapse;\n}\n.Dd_table td {\npadding: 6px;\ntext-align: right;\nborder-collapse:collapse;\nmin-width: 140px;\nborder-right: solid 1px #888888;\nborder-left: solid 1px #888888;\nborder-top: none;\nborder-bottom: none;\n\n}\n.Dd_table tr{\nborder: none;\n}\n.Dd_table tr :hover{\nbackground-color: #AAAAAA;\n}\n.Dd_table td a{\ncolor: black;\nfont-size: small;\ntext-decoration: none;\ndisplay: block;\n}";Ddmenu.inited=false;"use strict";function MapViewer(f,g,e,u){var s=this;$.addStyle(MapViewer.style);if(!g){g=47.874;e=8;this.map=L.map(f).setView([g,e],8)}else{if(!u){var u=13}this.map=L.map(f).setView([g,e],u)}this.popup=null;this.resize=function(){s.map.invalidateSize()};var l=function(n){var A="";if("lat" in n){A+="<br>Latitude: "+n.lat.toFixed(7)}if("lng" in n){A+="<br>Longitude: "+n.lng.toFixed(7)}if("ele" in n){A+="<br>Elevation: "+n.ele.toFixed(1)+"m"}if("dist" in n){A+="<br>Distance: ";if(n.dist<1000){A+=Math.round(n.dist)+"m"}else{if(n.dist<10000){A+=(n.dist/1000).toFixed(3)+"km"}else{A+=(n.dist/1000).toFixed(2)+"km"}}}return A};this.onSelect=null;this.show=function(n){if(!n){if(s.popup){s.popup.remove()}return}s.map.setView(n);s.popup=L.popup().setLatLng(n).setContent(l(n)).openOn(s.map);s.popup.place=Object.assign({},n)};s.map.on("click",function(n){p(n.latlng)});if(!MapViewer.map){alert("No map specified.");return}var y=L.tileLayer(MapViewer.map.url,MapViewer.map.opt).addTo(s.map);var o={};o[MapViewer.map.name]=y;var p=function(A){s.show(A);try{Elevation.get_elevation(A.lat,A.lng,function(B){s.show({lat:A.lat,lng:A.lng,ele:B})})}catch(n){}if(s.onSelect){s.onSelect({lat:A.lat,lng:A.lng})}};L.control.scale({imperial:false,maxWidth:200}).addTo(s.map);var b=null;var t=null;var r=function(K){var G=K.getElementsByTagName("map");for(var E=0;E<G.length;E++){if(G[E].getElementsByTagName("download_only")[0]!=undefined){continue}var F=document.createElement("option");F.text=G[E].getElementsByTagName("name")[0].childNodes[0].nodeValue;var B=G[E].getElementsByTagName("served_name")[0].childNodes[0].nodeValue;var A="";let idx=MapViewer.maps.lastIndexOf("/");if(idx>=0){A=MapViewer.maps.substring(0,idx+1)}A+=(B.trim()+"/{z}/{x}/{y}.png");o[F.text]=L.tileLayer(A,{maxZoom:17,tileSize:256,zoomOffset:0})}var I=K.getElementsByTagName("db");if(I!=undefined&&I.length>0){var C=new L.Control.Search({sourceData:w,position:"topleft",initial:false,marker:false});s.map.addControl(C);var n={};var J={exclusiveGroups:["Search"]};for(var E=0;E<I.length;E++){var F=document.createElement("option");F.text=I[E].getElementsByTagName("name")[0].childNodes[0].nodeValue;var D=L.polyline([[0,0]]);D.dbname=F.text;D.addEventListener("add",function(N){b=this.dbname});n[F.text]=D;if(E==1){D.addTo(s.map)}}var H={Search:n};t=L.control.groupedLayers(o,H,J);t.addTo(s.map)}else{t=L.control.groupedLayers(o);t.addTo(s.map)}};this.addPolyline=function(B,n,A){let polyline=L.polyline(n,{color:A}).addTo(s.map);polyline.name=B;return polyline};this.addTrack=function(B,n){var A=s.addPolyline(B,n,"#8b0000");A.addEventListener("add",function(){i(B)});A.addEventListener("remove",function(){z(B)});(function C(){if(t&&A){t.addOverlay(A,B,"Tracks")}else{setTimeout(C,300)}})()};var d=new Array();this.highlightTrack=function(A,n){let polyline=L.polyline(n,{color:"#ff4000"});polyline.name=A;d.push(polyline);let show=false;s.map.eachLayer(function(B){if(B.name&&B.name==A){show=true}});if(show){polyline.addTo(s.map)}};this.removeAllHighlights=function(){while(d.length>0){s.map.removeLayer(d.pop())}};var i=function(n){for(let k=0;k<d.length;k++){let h=d[k];if(h.name==n){h.addTo(s.map)}}};var z=function(n){for(let k=0;k<d.length;k++){let h=d[k];if(h.name==n){h.remove()}}};var q=new Array();this.addMarkers=function(A,n){let m=new Array();for(let k=0;k<n.length;k++){let marker=L.marker(n[k],{clickable:true});if(n[k].on){let keys=Object.keys(n[k].on);for(let j=0;j<keys.length;j++){marker.on(keys[j],n[k].on[keys[j]])}}m.push(marker)}var C=$.get("name",A,q);if(C){C.remove()}C=L.layerGroup(m).addTo(s.map);C.name=A;q.push(C);(function B(){if(t&&C){t.addOverlay(C,A,"Photos")}else{setTimeout(B,300)}})()};var v=function(C,A,n){var B=6371000;n[2]+=B;let M_fwd=M.rot(0,Math.PI/2-C,A);n=M.mv_mult(M_fwd,n);var D=new Array(2);D[0]=Math.atan2(n[2],Math.sqrt(n[0]*n[0]+n[1]*n[1]));D[1]=Math.atan2(n[1],n[0]);return D};var a=function(J,A,G,D){var n=750000/D;G=M.d2r(G);D=M.d2r(D);var O=M.d2r(J),F=M.d2r(A);var H=new Array();H.push([J,A]);for(var E=1;E<=20;E++){var C=n*E/20;var N=G+D/2;var K=[-C*Math.cos(N),C*Math.sin(N),0];var B=v(O,F,K);H.push([M.r2d(B[0]),M.r2d(B[1])])}for(var I=0.05;I<2*Math.PI-D;I+=0.05){var N=I+G+D/2;var K=[-n*Math.cos(N),n*Math.sin(N),0];var B=v(O,F,K);H.push([M.r2d(B[0]),M.r2d(B[1])])}for(var E=20;E>=1;E--){var C=n*E/20;var N=G-D/2;var K=[-C*Math.cos(N),C*Math.sin(N),0];var B=v(O,F,K);H.push([M.r2d(B[0]),M.r2d(B[1])])}return H};var x=null;this.markImagePosition=function(B,C,A,D){if(x){x.remove()}if(!B){return}var n={color:"black",weight:1,fillOpacity:0.3};x=L.polygon(a(B,C,A,D),n);x.addTo(s.map);x.setStyle({cursor:"crosshair"})};var c=function(A,B){let g=parseFloat(A);var n=A.indexOf(",");if(isNaN(g)||n==-1){return}let lng=parseFloat(A.substring(n+1));if(!isNaN(lng)){p({lat:g,lng:lng})}};var w=function(n,A){c(n,A);return{abort:function(){console.log("aborted request:"+n)}}};if(MapViewer.maps){$.load(MapViewer.maps,r,"document")}else{t=L.control.groupedLayers(o);t.addTo(s.map)}}MapViewer.style=".map:hover {\ncursor: crosshair;\n}\n.map:active {\ncursor: grab;\n}\n.leaflet-interactive {\ncursor: crosshair;\n}\n.leaflet-dragging .leaflet-grab,\n.leaflet-dragging .leaflet-grab .leaflet-interactive,\n.leaflet-dragging .leaflet-marker-draggable {\ncursor: grab;\n	\n}";"use strict";function loadDialog(j,b){var g='<div id="lD_bar"><h2><center>Add Image</center></h2></div>\n<br>\n<canvas id="lD_preview"> </canvas>\n<div> <span>Name</span> <input id="lD_name" type="text"> </div>\n<div> <span>File</span> <input id="lD_file" type="text" readonly> </div>\n<div> <span>Directory</span> <input id="lD_dir" type="text"> </div>\n<div> <span>Camera</span> <input id="lD_cam" type="text"> </div>\n<div> <span>Position</span>\n<input id="lD_pos" type="text" value="Click Map" readonly></div>\n<div> <span>Rotate</span>\n<select id="lD_rot"> \n<option selected> 0°\n<option> 90°\n<option> -90°\n</select>\n</div>\n<input type="button" id="lD_cancel" value="Cancel">\n<input type="button" id="lD_ok" value="Add">';j.innerHTML=g;var o="#loadDlg{\ndisplay: none;\npadding: 20px;\nposition: absolute;\nright: 100px;\ntop: 50px;\nbackground-color: #f1f1f1;\nbox-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);\nz-index: 1;\nfont-size: small;\nborder-style: solid;\nborder-color: #888888;\nborder-radius: 5px;\nborder-width: 2px;\nbackground-color: #FFFFFF;\n}\n#lD_bar{\nwidth: 100%;\nheight: 30px;\nmargin: 0px;\nbackground-color: #E0E0E0;\n}\n#preview{\nwidth: 100%;\n}\n#loadDlg1{\nposition: absolute;\ntop: 45px;\nright: 40px;\npadding: 20px;\nbackground-color: rgba(209, 209, 209, 0.58);\nmargin: auto;\nmargin-top: 20px;\nline-height: 30px;\nwidth: 500px;\n}\n#loadDlg span {\nmargin-top: 10px;\npadding-left: 40px;\ndisplay: inline-block;\nwidth: 30%;\n}\n#loadDlg input, #loadDlg select {\nmin-height: 25px;\ndisplay: inline-block;\nwidth: 50%;\nmin-width: 80px;\n}\n\n\n\n\n#lD_cancel, #lD_ok {\ndisplay: inline-block;\nmax-width: 80px;\nmargin-top: 10px;\nmargin-left: 10%;\n}\n#lD_cancel {\nmargin-left: 20%;\n}";$.addStyle(o);var f=false;var h=100,e=50;var l=null;$("#lD_ok").addEventListener("click",function(t){if(l){if($("#lD_pos").value=="Click Map"){alert("No position specified.");return}l()}m()});$("#lD_cancel").addEventListener("click",function(t){m()});$("#lD_bar").addEventListener("mousemove",function(t){t.preventDefault();if(f){h-=t.movementX;e+=t.movementY;$("#loadDlg").style.right=h+"px";$("#loadDlg").style.top=e+"px"}});$("#lD_bar").addEventListener("mousedown",function(t){t.preventDefault();f=true});$("#lD_bar").addEventListener("mouseup",function(){f=false});$("#lD_bar").addEventListener("mouseleave",function(){});$("#lD_bar").addEventListener("mouseover",function(){f=false});var c=function(t){let r="",p=["f","v"];for(let k=0;k<p.length;k++){let s=p[k];r+=s+Camera.getparam(t,s)+" "}p=["a","b","c","d","e"];for(let k=0;k<p.length;k++){let s=p[k];let q=Camera.getparam(t,s);if(q!=0){r+=s+q+" "}}return r};var a=function(t){let n=t.lastIndexOf("/");if(n>=0){return t.substring(0,n)}return""};var i=function(t){return function(u){$("#lD_pos").value=u.latlng.lat.toFixed(6)+" / "+u.latlng.lng.toFixed(6);Elevation.get_elevation(u.latlng.lat,u.latlng.lng,function(v){t.pos="f12 d"+u.latlng.lng+" e"+u.latlng.lat+" h"+(v+1.5)})}};var d=new ImageViewer("lD_preview");this.load=function(v,u,t){let img={url:v.name,cam:""};d.show_image(URL.createObjectURL(v),0,function(x,y){img.cam+="w"+x+" h"+y+" "});j.style.display="block";$("#lD_name").value=v.name;$("#lD_file").value=v.name;$("#lD_pos").value="Click Map";if(u){$("#lD_cam").value=c(u.cam);$("#lD_dir").value=a(u.url)}else{$("#lD_cam").value="f0 v50"}l=function(){img.name=$("#lD_name").value;img.url=$("#lD_dir").value+"/"+img.url;img.cam+="p0 y0 r0 "+$("#lD_cam").value+" ";let rot=$("#lD_rot").selectedIndex;img.rot=(rot==0?0:(rot==1?90:-90));t(img)};l.set=i(img);b.map.on("click",l.set)};var m=function(){if(l){b.map.off("click",l.set);l=null}j.style.display="none"}};"use strict";var Confirm={_html:'<div id="cf_bar"></div>\n<br>\n<div id="cf_message"> </div>\n<input type="button" id="cf_cancel" value="Cancel">\n<input type="button" id="cf_ok" value="Apply">',_styles:"#confirm{\ndisplay: none;\npadding: 20px;\nposition: absolute;\nright: 100px;\ntop: 50px;\nbackground-color: #f1f1f1;\nbox-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);\nz-index: 1;\nfont-size: small;\nborder-style: solid;\nborder-color: #888888;\nborder-radius: 5px;\nborder-width: 2px;\nbackground-color: #FFFFFF;\n}\n#cf_bar{\nwidth: 100%;\nheight: 30px;\nmargin: 0px;\nbackground-color: #E0E0E0;\n}\n",_inited:false,_init:function(){$("#confirm").innerHTML=Confirm._html;let styleSheet=document.createElement("style");styleSheet.type="text/css";styleSheet.innerText=Confirm._styles;document.head.appendChild(styleSheet);$("#cf_ok").addEventListener("click",function(a){if(Confirm._callback){Confirm._callback()}Confirm._close()});$("#cf_cancel").addEventListener("click",function(a){Confirm._close()});$("#cf_bar").addEventListener("mousemove",function(a){a.preventDefault();if(Confirm._dragging){Confirm._right-=a.movementX;Confirm._top+=a.movementY;$("#confirm").style.right=Confirm._right+"px";$("#confirm").style.top=Confirm._top+"px"}});$("#cf_bar").addEventListener("mousedown",function(a){a.preventDefault();Confirm._dragging=true});$("#cf_bar").addEventListener("mouseup",function(){Confirm._dragging=false});$("#cf_bar").addEventListener("mouseleave",function(){});$("#cf_bar").addEventListener("mouseover",function(){Confirm._dragging=false});Confirm._inited=true},_dragging:false,_right:100,_top:50,_callback:null,show:function(a,b,c){if(!Confirm._inited){Confirm._init()}$("#cf_bar").innerHTML=a;$("#cf_message").innerHTML=b;$("#confirm").style.display="block";Confirm._callback=c},_close:function(){Confirm._callback=null;$("#confirm").style.display="none"}};"use strict";function Align(dd,imgViewer,mapViewer){var geoImg=null,img=null;var cpts;var edit=false;this.setImage=function(i,g){img=i;geoImg=g;edit=ImageMapViewer.options.edit;if(edit){if(img.cpts){for(let k=0;k<img.cpts.length;k++){let cp=img.cpts[k];if(!cp.x&&cp.length==5){img.cpts[k]={x:cp[0],y:cp[1],lat:cp[2],lng:cp[3],ele:cp[4]}}}}else{img.cpts=new Array()}cpts=img.cpts}dd.menu.setMenu({text:img.name},createMenu)};var cpt_equal=function(a,b){return a.x==b.x&&a.y==b.y&&a.lat==b.lat&&a.lng==b.lng};var geo_equal=function(a,b){return a.lat==b.lat&&a.lng==b.lng};var cpt_idx=function(c){for(let k=0;k<cpts.length;k++){if(cpt_equal(c,cpts[k])){return k}}return -1};var cpt_geo_idx=function(c){for(let k=0;k<cpts.length;k++){if(geo_equal(c,cpts[k])){return k}}return -1};var rmCpt=function(k){for(let i=k;i<cpts.length-1;i++){cpts[i]=cpts[i+1]}cpts.length--};var setCpt=function(k,c){cpts[k]={x:c.x,y:c.y,lat:c.lat,lng:c.lng,ele:c.ele}};var cpt_string=function(cp){return"{x:"+cp.x+",y:"+cp.y+",lat:"+cp.lat+",lng:"+cp.lng+",ele:"+cp.ele+"}"};var showCpt=function(k){let c=Object.assign({},cpts[k]);let xy=geoImg.imagecoords(c);c.x2=xy[0];c.y2=xy[1];c.color2="#33aa22";c.center=true;mapViewer.show({lat:c.lat,lng:c.lng,ele:c.ele});imgViewer.mark(c)};var exportcpt=function(){var s="% "+img.url+"\n";s+="lenstype = "+Camera.getparam(img.cam,"f")+";\n";s+="cam = ["+Camera.getparam(img.cam,"v").toFixed(4)+", "+Camera.getparam(img.cam,"a").toFixed(4)+", "+Camera.getparam(img.cam,"b").toFixed(4)+", "+Camera.getparam(img.cam,"c").toFixed(4)+", "+Camera.getparam(img.cam,"d").toFixed(4)+", "+Camera.getparam(img.cam,"e").toFixed(4)+", "+Camera.getparam(img.cam,"w")+", "+Camera.getparam(img.cam,"h")+"];\n";s+="pyr = ["+Camera.getparam(img.cam,"p").toFixed(4)+", "+Camera.getparam(img.cam,"y").toFixed(4)+", "+Camera.getparam(img.cam,"r").toFixed(4)+"];\n";s+="pcam = ["+Camera.getparam(img.pos,"e").toFixed(7)+", "+Camera.getparam(img.pos,"d").toFixed(7)+", "+Camera.getparam(img.pos,"h").toFixed(1)+"];\n";s+="cp = [";for(var k=0;k<cpts.length;k++){var c=cpts[k];if(k>0){s+="\n"}s+="["+c.x.toFixed(1)+", "+c.y.toFixed(1)+", "+c.lat.toFixed(7)+", "+c.lng.toFixed(7)+", "+Elevation.get_elevation(c.lat,c.lng).toFixed(1)+"]"}s+="];\n";var cpt_window=window.open("","Control Points","width=600,height=600,menubar=yes,toolbar=yes,scrollbars=yes");cpt_window.document.write("<pre>\n"+s+"</pre>")};var translateMatlabArray=function(text){var isNum=function(c){return c>="0"&&c<="9"};let tokens=text.split(" "),r="";if(tokens.length>0){r=tokens[0]}let pt=r;for(let k=1;k<tokens.length;k++){let t=tokens[k];if(isNum(t.charAt(0))&&isNum(pt.charAt(pt.length-1))){r+=","+t}else{r+=" "+t}pt=t}return r};var pyr,cp,cam,pcam,lenstype;var evalMatlab=function(text){let lines=text.split("\n"),p="";for(let k=0;k<lines.length;k++){let line=lines[k].trim();console.log("line: "+line);if(line[0]=="%"){continue}line=translateMatlabArray(line);console.log("tline: "+line);if(line.endsWith(";")){eval(p+line);p=""}else{if(line.length>0){p+=line+","}}}};var loadcpt=function(url){$.load(url,function(text){if(!text){alert("Failed to load "+url);return}evalMatlab(text);let c=Camera.setparam(img.cam,"f",lenstype);c=Camera.setparam(c,"p",pyr[0]);c=Camera.setparam(c,"y",pyr[1]);c=Camera.setparam(c,"r",pyr[2]);c=Camera.setparam(c,"v",cam[0]);c=Camera.setparam(c,"a",cam[1]);c=Camera.setparam(c,"b",cam[2]);c=Camera.setparam(c,"c",cam[3]);c=Camera.setparam(c,"d",cam[4]);c=Camera.setparam(c,"e",cam[5]);c=Camera.setparam(c,"w",cam[6]);c=Camera.setparam(c,"h",cam[7]);img.cam=c;let p=Camera.setparam(img.pos,"d",pcam[1]);p=Camera.setparam(p,"e",pcam[0]);p=Camera.setparam(p,"h",pcam[2]);img.pos=p;img.cpts=new Array();cpts=img.cpts;for(let k=0;k<cp.length;k++){let c=cp[k];img.cpts[k]={x:c[0],y:c[1],lat:c[2],lng:c[3],ele:c[4]}}window.dispatchEvent(new CustomEvent("imagechanged",{detail:img}))})};var chead="<center><h2>Optimization Result</h2></center>";var format_pyr=function(pyr){return"p = "+pyr.p.toFixed(3)+"°, y = "+pyr.y.toFixed(3)+"°, r = "+pyr.r.toFixed(3)+"°<p>Rms = "+pyr.lrms.toFixed(2)+"° = "+(pyr.lrms*Camera.getparam(img.cam,"w")/Camera.getparam(img.cam,"v")).toFixed(1)+"px"};var errtable=function(err){let ctext="<p>Pixel Errors <b>px</b> for control points <b>n</b>:\n<center><table id='errtable'>\n";let n=err.length/3+1;ctext+="<tr><th>n</th><th>px</th><th></th><th>n</th><th>px</th><th></th><th>n</th><th>px</th><th></th></tr>";for(let k=0;k<n;k++){ctext+="<tr>";let k1=3*k;if(k1<err.length){ctext+="<td>"+k1+"</td><td>"+err[k1].toFixed(1)+"</td><td></td>"}k1=3*k+1;if(k1<err.length){ctext+="<td>"+k1+"</td><td>"+err[k1].toFixed(1)+"</td><td></td>"}k1=3*k+2;if(k1<err.length){ctext+="<td>"+k1+"</td><td>"+err[k1].toFixed(1)+"</td><td></td>"}ctext+="</tr>\n"}ctext+="</table></center>";return ctext};var tryAgain=function(f,err){if(err=="ElevationPending"){setTimeout(f,2000)}else{console.log("Elevation not available")}};var drawHorizon=function(){let hold=imgViewer.rmTrack("horizon");if(hold){if(hold.map){mapViewer.map.removeLayer(hold.map)}return}var mark=function(){try{let h=new Array(),hm=new Array();if(geoImg.rot==0){for(let x=0;geoImg.inside([x,0]);x+=5){let d=geoImg.horizon(x);h.push(x);h.push(d.px);hm.push([d.lat,d.lng])}}else{for(let y=0;geoImg.inside([0,y]);y+=5){let d=geoImg.horizon(y);h.push(d.px);h.push(y);hm.push([d.lat,d.lng])}}h.color="#229955";h.name="horizon";imgViewer.markTrack(h);h.map=mapViewer.addPolyline(h.name,hm,h.color)}catch(err){tryAgain(mark,err)}};mark()};var LMoptimize=function(astr){let xdata=[],ydata=[];for(let k=0;k<cpts.length;k++){let c=cpts[k];xdata.push({lng:c.lng,lat:c.lat,ele:c.ele});ydata.push([c.x,c.y])}let par=astr.split(",");let g=geoImg.clone();let sc=(" "+img.cam).slice(1);var getcstr=function(p){for(let k=0;k<par.length;k++){let v=par[k].trim();if(v.charAt(0)=="h"){xdata[parseFloat(v.substring(1))].ele=p[k]}else{sc=Camera.setparam(sc,v,p[k])}}return sc};var getcpar=function(sc){let p=[];for(let k=0;k<par.length;k++){let v=par[k].trim();if(v.charAt(0)=="h"){let i=parseFloat(v.substring(1)),x=xdata[i];p[k]=x.ele}else{p[k]=Camera.getparam(sc,par[k].trim())}}return p};var f=function(p,x){g.setCamera(getcstr(p));return g.imagecoords(x)};let p=getcpar(sc);p=M.lmsolve(f,p,xdata,ydata,0.5);for(let k=0;k<p.length;k++){let s=""+p[k].toFixed(5);p[k]=parseFloat(s)}let ctext="Optimized camera parameters: <br>";for(let k=0;k<par.length;k++){let v=par[k].trim();if(v.charAt(0)=="h"){ctext+="<br>"+v+": "+p[k]}else{ctext+="<br>"+Camera.setparam("",v,p[k])}}ctext+="<br>Error: "+p.s.toFixed(2)+" max = "+p.mx.toFixed(2)+" at point "+p.nx;ctext+="<p>Use these values?";Confirm.show(chead,ctext,function(){for(let k=0;k<par.length;k++){let v=par[k].trim();if(v.charAt(0)!="h"){img.cam=Camera.setparam(img.cam,par[k].trim(),p[k])}}window.dispatchEvent(new CustomEvent("imagechanged",{detail:img}))})};var createMenu=function(){let m1=new Array(),m2=new Array();if(img==null){return m1}let k=-1;if(edit){if(cpts.length>0){cpts.map(function(c){if(!("ele" in c)&&Elevation){Elevation.get_elevation(c.lat,c.lng,function(h){c.ele=parseFloat(""+h.toFixed(1))})}});m1.push({text:"Control Points"})}if(imgViewer.marker&&mapViewer.popup&&mapViewer.popup.isOpen()){if(cpts.length==0){m1.push({text:"Control Points"})}let latlng=mapViewer.popup.place;let cp={x:imgViewer.marker.x,y:imgViewer.marker.y,lat:latlng.lat,lng:latlng.lng,ele:latlng.ele};cp.x=M.round_dec(cp.x,2);cp.y=M.round_dec(cp.y,2);k=cpt_idx(cp);if(k>=0){m1.push({onclick:function(){rmCpt(k)},text:"Remove "+k})}else{k=cpt_geo_idx(cp);let r={onclick:function(){setCpt(k,cp)}};if(k>=0){r.text="Change "+k}else{k=cpts.length;r.text="Add "+k}m1.push(r)}m1.push({onclick:function(){img.pos="f12 d"+cp.lng+" e"+cp.lat+" h"+(cp.ele+1.5);window.dispatchEvent(new CustomEvent("imagechanged",{detail:img}))},text:"Set Position"})}for(let j=0;j<cpts.length;j++){if(j==k){continue}m1.push({onclick:function(){showCpt(j)},text:"Show "+j})}m2.push({text:"Align"});m2.push({onclick:function(){if(cpts.length==0){alert("No control points selected.");return}let pyr=geoImg.optimize(cpts);let ctext=format_pyr(pyr);ctext+=errtable(pyr.err);ctext+="<p>Use these values?";Confirm.show(chead,ctext,function(){let cam=Camera.setparam(img.cam,"p",M.round_dec(pyr.p,5));cam=Camera.setparam(cam,"y",M.round_dec(pyr.y,5));cam=Camera.setparam(cam,"r",M.round_dec(pyr.r,5));img.cam=cam;window.dispatchEvent(new CustomEvent("imagechanged",{detail:img}))})},text:"p-y-r"});m2.push({onclick:function(){if(cpts.length==0){alert("No control points selected.");return}let g=geoImg.clone();var fopt=function(hfov){g.cam.setHfov(M.d2r(hfov));return g.optimize(cpts).lrms};var dfopt=M.diff(fopt,0.000001);var hopt=M.bisection(dfopt,1,179,0.001);let pyr=g.optimize(cpts);let ctext="Hfov = "+hopt.toFixed(3)+"°<p>";ctext+=format_pyr(pyr);ctext+=errtable(pyr.err);ctext+="<p>Use these values?";Confirm.show(chead,ctext,function(){let cam=Camera.setparam(img.cam,"p",M.round_dec(pyr.p,5));cam=Camera.setparam(cam,"y",M.round_dec(pyr.y,5));cam=Camera.setparam(cam,"r",M.round_dec(pyr.r,5));cam=Camera.setparam(cam,"v",M.round_dec(hopt,5));img.cam=cam;window.dispatchEvent(new CustomEvent("imagechanged",{detail:img}))})},text:"Hfov-p-y-r"});m2.push({onclick:function(){if(cpts.length==0){alert("No control points selected.");return}let g=geoImg.clone();var fopt=function(x){g.latlon=new Latlng(x[0]/100000,x[1]/100000,x[2]);return g.optimize(cpts).lrms};let pos=Latlng.position(img.pos),xp=[pos.lng*100000,pos.lat*100000,pos.ele];var popt=M.grad_desc(fopt,xp,10,0.1);let ele=Elevation.get_elevation(popt[1]/100000,popt[0]/100000);if(ele>popt[2]){console.log("Warning: optimized elevation "+popt[2].toFixed(1)+"m is below ground level: "+ele.toFixed(1)+"m");console.log("Fixing to "+(ele+1.5).toFixed(1)+"m.");popt[2]=ele+1.5}g.latlon=new Latlng(popt[0]/100000,popt[1]/100000,popt[2]);let pyr=g.optimize(cpts);let ctext="Lat = "+(popt[1]/100000).toFixed(6)+"°, Lon = "+(popt[0]/100000).toFixed(6)+"°, Elevation = "+popt[2].toFixed(1)+"m<p>";ctext+=format_pyr(pyr);ctext+=errtable(pyr.err);ctext+="<p>Use these values?";Confirm.show(chead,ctext,function(){let cam=Camera.setparam(img.cam,"p",M.round_dec(pyr.p,5));cam=Camera.setparam(cam,"y",M.round_dec(pyr.y,5));cam=Camera.setparam(cam,"r",M.round_dec(pyr.r,5));img.cam=cam;let pos=Camera.setparam(img.pos,"d",M.round_dec(popt[0]/100000,7));pos=Camera.setparam(pos,"e",M.round_dec(popt[1]/100000,7));pos=Camera.setparam(pos,"h",M.round_dec(popt[2],2));img.pos=pos;window.dispatchEvent(new CustomEvent("imagechanged",{detail:img}))})},text:"Location-p-y-r"});m2.push({onclick:function(){if(cpts.length==0){alert("No control points selected.");return}let astr=prompt("Alignment parameters (any combination of v, p, y, r, a, b, c, d, e, h + Nr., eg: v,d,e,h7,h9");if(astr){LMoptimize(astr)}},text:"LMSolver"})}m2.push({text:"File"});if(edit){m2.push({onclick:function(e){var view=window.open("","","width=600,height=600,menubar=yes,toolbar=yes,scrollbars=yes");geoImg.depthimage(Math.round(geoImg.getWidth()/Align.depthScale),0,view)},text:"Depthmap"});m2.push({onclick:function(){let scale=prompt("Scale down depthmap by ",""+Align.depthScale);if(scale){scale=parseFloat(scale);if(scale>0){Align.depthScale=parseFloat(scale)}else{alert("Illegal value")}}},text:"Scale"});m2.push({onclick:function(){let radius=prompt("Maximum Depth ",(Latlng.maxDist/1000)+"km");if(radius){radius=parseFloat(radius);if(radius>0){Latlng.maxDist=radius*1000}else{alert("Illegal value")}}},text:"MaxDepth"});m2.push({onclick:function(){let thm=imgViewer.thumbNail(128);img.thm=thm},text:"Create Thumbnail"})}m2.push({onclick:function(e){let info=window.open("","","width=600,height=600,menubar=yes,toolbar=yes,scrollbars=yes");info.document.writeln(Align.infohead);info.document.writeln("<h3>"+img.name+"</h3><dl>");let latlng=Latlng.position(img.pos);info.document.writeln("<dt>Latitude:</dt><dd>"+latlng.lat.toFixed(6)+"°</dd>");info.document.writeln("<dt>Longitude:</dt><dd>"+latlng.lng.toFixed(6)+"°</dd>");info.document.write("<dt>Elevation:</dt><dd>");try{let ele=Elevation.get_elevation(latlng.lat,latlng.lng);info.document.writeln(latlng.ele.toFixed(1)+"m, "+(latlng.ele-ele).toFixed(1)+"m above ground.  </dd>")}catch(err){info.document.writeln(latlng.ele+"m</dd>")}info.document.write("<dt>View:</dt><dd>");switch(Camera.getparam(img.cam,"f")){case 0:info.document.write("Rectilinear, ");break;case 1:info.document.write("Cylindrical, "+("rot" in img&&img.rot!=0?"vertical, ":""));break;default:info.document.write("Fisheye, ");break}let yf=geoImg.yawfov();info.document.writeln(yf.v.toFixed(1)+"° Field of View</dd>");info.document.writeln("<dt>Orientation (pitch / yaw / roll):</dt><dd>"+Camera.getparam(img.cam,"p").toFixed(1)+"° / "+Camera.getparam(img.cam,"y").toFixed(1)+"° / "+Camera.getparam(img.cam,"r").toFixed(1)+"°</dd>");if("model" in img){info.document.write("<dt>Camera:</dt><dd>"+img.model+"</dd>")}if("date" in img){info.document.write("<dt>Date:</dt><dd>"+img.date+"</dd>")}if("attr" in img){info.document.write("<dt>Attribution:</dt><dd>"+img.attr+"</dd>")}info.document.writeln("</dl>");if("info" in img){for(let k=0;k<img.info.length;k++){info.document.writeln(img.info[k])}}info.document.writeln(Align.infofoot)},text:"Info"});if(edit){m2.push({onclick:function(){$.exportObj([img])},text:"Export JSON"})}m2.push({text:"Horizon"});m2.push({onclick:drawHorizon,text:"Show / Hide"});m2.push({onclick:function(){let radius=prompt("Search Horizon up to ",((geoImg.searchTo?geoImg.searchTo:Latlng.searchTo)/1000)+"km");if(radius){radius=parseFloat(radius);if(radius>0){if(geoImg.searchTo){geoImg.searchTo=radius*1000}else{Latlng.searchTo=radius*1000}}else{alert("Illegal value")}}},text:"Search to"});if(edit){m2.push({onclick:function(){let radius=prompt("Search Horizon from ",(Latlng.searchFrom)+"m");if(radius){radius=parseFloat(radius);if(radius>0){Latlng.searchFrom=radius}else{alert("Illegal value")}}},text:"Search from"});m2.push({onclick:function(){let step=prompt("Set search step (m)",(Latlng.searchStep)+"m");if(step){step=parseFloat(step);if(step>0&&step<10000){Latlng.searchStep=step}else{alert("Illegal value")}}},text:"Search step"})}if(m1.length==0){return m2}if(m1.length<=m2.length){for(let j=m1.length;j<m2.length;j++){m1.push({text:""})}m1=m1.concat(m2);m1.nc=2;m1.nr=m2.length;return m1}let nr=15;let n1=Math.ceil(m1.length/nr);while(n1*nr-m1.length>=n1&&nr>m2.length){nr--}for(let j=m1.length;j<n1*nr;j++){m1.push({text:""})}m1=m1.concat(m2);m1.nc=n1+1;m1.nr=nr;return m1}}Align.infohead='\n<style>\n.info {\n		box-sizing: border-box;\n		min-width: 200px;\n		max-width: 980px;\n		margin: 0 auto;\n		padding: 45px;\n	}\n\n	@media (max-width: 767px) {\n		.info {\n			padding: 15px;\n		}\n	}\n</style>\n<article class="info">\n';Align.infofoot="</article>";Align.depthScale=2;"use strict";function ImageMapViewer(){document.body.innerHTML=ImageMapViewer.html;$.addStyle(ImageMapViewer.style);var h=null;var E=null;var o=new Array();var j=new ImageViewer("imgid","{ height: 100%; position: absolute; top: 0px;margin: 0px; background-color: #767778; }");var v=null;var F=new Array();var u=null;var O=null;var y=1/2;var z=false;var e=0;var q=function(A){if(A.type=="mousedown"){e=A.offsetX}else{let rect=A.target.getBoundingClientRect();e=A.targetTouches[0].pageX-rect.left}z=true};$("#slider").addEventListener("mousedown",q);$("#slider").addEventListener("touchstart",q);var g=function(){z=false};$("#slider").addEventListener("mouseup",g);$("#slider").addEventListener("touchend",g);$("#slider").addEventListener("touchcancel",g);$("#slider").addEventListener("mouseleave",function(){});var r=function(){let wc=Math.round(window.innerWidth*y);$("#mapid").style.width=(window.innerWidth-wc-20)+"px";$("#slider").style.left=(window.innerWidth-wc-20)+"px";$("#imgid").style.left=(window.innerWidth-wc)+"px";$("#loadicon").style.left=(window.innerWidth/2-200)+"px";$("#loadicon").style.top=(window.innerHeight/2-200)+"px";$("#imgid").style.width=wc;$("#imgid").width=wc;$("#imgid").height=window.innerHeight};window.addEventListener("datapending",function(A){if(A.detail){$("#loadicon").style.display="block"}else{$("#loadicon").style.display="none"}});window.addEventListener("imagechanged",function(A){a(A.detail.name)});window.addEventListener("resize",function(){r();if(j){j.repaint()}if(h){h.resize()}});var H=function(A){var I=function(P){return P&&P.type.split("/")[0]==="image"};if(I(A)){if(!h){L()}let url=URL.createObjectURL(A);$.load(url,function(P){if(!P){alert("Failed to load "+A.name);return}let xmp=$.getXML("x:xmpmeta",P);if(xmp){let cam=$.getXML(["exif:PT_CAM","rdf:Alt","rdf:li"],xmp);let pos=$.getXML(["exif:PT_POS","rdf:Alt","rdf:li"],xmp);let name=$.getXML(["exif:PT_NAME","rdf:Alt","rdf:li"],xmp);let rot=$.getXML(["exif:PT_ROT","rdf:Alt","rdf:li"],xmp);if(cam&&pos){Camera.setparam(pos,"f",12);if(!name){name=A.name}if(rot){rot=parseFloat(rot)}let O={cam:cam,pos:pos,url:url,name:name,rot:(rot?rot:0)};o.push(O);C(o);a(O.name);return}}if(ImageMapViewer.options.edit){E.load(A,O,function(Q){o.push(Q);C(o);a(Q.name)})}else{alert("Image contains no alignment metadata. Edit Mode required.")}})}else{if(A.name.endsWith(".json")||A.name.endsWith(".JSON")){D(URL.createObjectURL(A),A.name)}else{alert(A.name+" is not an image.")}}};var m=function(I,A){if(A=="ElevationPending"){setTimeout(I,2000)}else{console.log("Elevation not available "+A)}};var l=function(I){var A=function(){try{let xy=v.imagecoords(I);if(!v.inside(xy)){return}let p={x:xy[0],y:xy[1],center:true};let visible=(v.latlon?v.latlon.isVisible(I.lng,I.lat):xy.vis);if(!visible){p.color="#DD8833"}j.mark(p);let dist=(v.latlon?v.latlon.distance(I.lng,I.lat):xy.dist);if(h.popup){let content=h.popup.getContent();let text="<br>Distance: "+Math.round(dist)+"m";if(content.indexOf("Elevation")<0&&"ele" in xy){text+="<br>Elevation: "+xy.ele.toFixed(1)+"m"}h.popup.setContent(content+text)}}catch(P){m(A,P)}};A()};var G=function(A){var I=function(){try{let lnglat=v.geocoords(A.x,A.y);if(lnglat&&lnglat.length>=4){let place={lng:lnglat[0],lat:lnglat[1],dist:lnglat[2],ele:lnglat[3]};h.show(place)}else{h.show(null)}}catch(P){m(I,P)}};I()};var D=function(I,A){$.load(I,function(P){if(!P){alert("Failed to load "+I);return}let ilist=JSON.parse(P);if(Array.isArray(ilist)){ilist.name=(A?A:I);if(ilist.length>0){C(ilist);N(ilist,0)}}else{let names=Object.keys(ilist);for(let k=0;k<names.length;k++){let A=names[k],db=ilist[A];db.name=A;C(db)}if(names.length>0&&ilist[names[0]].length>0){N(ilist[names[0]],0)}}})};var C=function(A){let markers=new Array();for(let k=0;k<A.length;k++){let i=A[k];let latlng=[Camera.getparam(i.pos,"e"),Camera.getparam(i.pos,"d")];latlng.on={click:function(){N(A,k)}};if(i.thm){latlng.on.mouseover=function(I){let p=I.containerPoint;J(i.thm,{top:p.y,left:p.x})};latlng.on.mouseout=function(I){w()}}markers.push(latlng)}if(!h){L()}if(!("name" in A)){A.name="default"}if(markers.length>0&&h){h.addMarkers(A.name,markers)}};var N=function(I,A){if(A<I.length){o=I;a(I[A].name)}};var L=function(I,P,A){let n=13;if(A){let res=(2*750000/A)/1000;let n2=2*Math.PI*6371000/(res*256);n=Math.floor(Math.log(n2)/Math.log(2))}if(!h){h=new MapViewer("mapid",I,P,n);h.onSelect=function(Q){if(v.isAligned){l(Q)}};h.map.on("overlayremove",function(Q){if(O.track){let f=function(R){if(Q.name==R.name){j.showTracks(false,Q.name)}};if(Array.isArray(O.track)){O.track.map(f)}else{f(O.track)}}});h.map.on("overlayadd",function(Q){if(O.track){let f=function(R){if(Q.name==R.name){j.showTracks(true,Q.name)}};if(Array.isArray(O.track)){O.track.map(f)}else{f(O.track)}}});E=new loadDialog($("#loadDlg"),h)}else{h.map.setView([I,P],n)}};var a=function(A){w();O=$.get("name",A,o);if(!O){alert("Image "+A+" does not exist.");return}if(ImageMapViewer.options.edit||!("depth" in O)){if(!Elevation){alert("No Elevation data specified.");return}v=new Geoimg(O)}else{v=new Geoimg2(O)}let hold=j.rmTrack("horizon");if(hold){if(hold.map&&h){h.map.removeLayer(hold.map)}}j.show_image(O.url,O.rot);let lat=Camera.getparam(O.pos,"e"),lon=Camera.getparam(O.pos,"d");let fov=(O.rot&&(O.rot==90||O.rot==-90))?M.r2d(v.cam.getVfov()):Camera.getparam(O.cam,"v");L(lat,lon,fov);let yaw=Camera.getparam(O.cam,"y"),pitch=Camera.getparam(O.cam,"p"),roll=Camera.getparam(O.cam,"r");if(v.isAligned){let yv=v.yawfov();h.markImagePosition(lat,lon,yv.y,yv.v)}else{h.markImagePosition()}if(O.track){h.removeAllHighlights();if(Array.isArray(O.track)){O.track.map(b)}else{b(O.track)}}if(u==null){u=new Align($("#imgtitle"),j,h)}u.setImage(O,v)};var K=function(A){if(z){let wcn=$("#imgid").width+e-A;y=wcn/window.innerWidth;r();if(j){j.repaint()}if(h){h.resize()}}};var b=function(I){var S=function(T){try{let s=v.visibleTrack(T,I.ele);var V=s.img.length,U;for(let U=0;U<V;U++){s.img[U].name=I.name;j.markTrack(s.img[U]);h.highlightTrack(I.name,s.map[U])}}catch(W){m(function(){S(T)},W)}};if(I.name in F){S(F[I.name]);return}var Q=function(T){let c=T.getElementsByTagName("coordinates")[0].childNodes[0].nodeValue;let cs=c.split(/[ \n]/);let track=new Array();for(let k=0;k<cs.length;k++){let cc=cs[k].split(",");if(cc.length<2){continue}let t={lng:parseFloat(cc[0]),lat:parseFloat(cc[1])};if(cc.length>2){t.ele=parseFloat(cc[2])}track.push(t)}return track};var P=function(T){let trkpts=T.getElementsByTagName("trkpt");let track=new Array(trkpts.length);for(let k=0;k<trkpts.length;k++){let t=trkpts[k];let lat=parseFloat(t.getAttribute("lat"));let lng=parseFloat(t.getAttribute("lon"));track[k]={lat:lat,lng:lng};if(t.getElementsByTagName("ele").length>0){track[k].ele=parseFloat(t.getElementsByTagName("ele")[0].childNodes[0].nodeValue)}}return track};var A=function(U){var W=new DataView(U),T=U.byteLength,Y=0;var X=function(){if(Y>=T){throw"EndOfBuffer"}let x=W.getInt32(Y,true);Y+=4;return x};let hlen=36;while(hlen-->0){X()}let n=0;let track=new Array();try{while(true&&Y<T){while(X()!=n){}let lng=X()/100000000*180/Math.PI;let lat=X()/100000000*180/Math.PI;let ele=X()/100;let spd=(X()-196608)/10;X();X();X();let t=X();track.push({lng:lng,lat:lat,ele:ele,spd:spd,time:t});n++}}catch(V){}return track};var R=function(T){F[I.name]=T;h.addTrack(I.name,T);S(T)};let lowercase=I.url.toLowerCase();if(lowercase.endsWith("kml")){$.load(I.url,function(T){if(T){R(Q(T))}},"document")}else{if(lowercase.endsWith("gpx")){$.load(I.url,function(T){if(T){R(P(T))}},"document")}else{if(lowercase.endsWith("tur")){$.load(I.url,function(T){if(T){R(A(T))}},"arraybuffer")}else{console.log("Unsupported Track format "+I.url)}}}};if(!ImageMapViewer.options){ImageMapViewer.options={}}$.getOpt(ImageMapViewer.options);r($("#imgid"));if(ImageMapViewer.options.database){D(ImageMapViewer.options.database)}new Ddmenu("imgtitle","{right: 75px;}");new Ddmenu("imgmenu2",["{right: 12px;}",".Dd_title {min-width: 30px;}"]);$("#imgmenu2").menu.setMenu({text:"&#x2263;",onclick:function(A){H(A.target.files[0])},ctrl:"file"},function(){let x=new Array();x.push({onclick:function(){let win=window.open("","","width=600,height=600,menubar=yes,toolbar=yes,scrollbars=yes");win.document.write("<pre>\n"+Preambel+"</pre>")},text:"About"});if(ImageMapViewer.options.edit){x.push({onclick:function(){$.exportObj(o)},text:"Export List"})}for(let k=0;k<o.length;k++){let ci=o[k];let menuItem={onclick:function(){a(ci.name)},text:ci.name};if(ci.thm){menuItem.onhover=function(A,I){if(A){J(ci.thm,I)}else{w()}}}x.push(menuItem)}return x});var d=null;var J=function(A,I){w();d=document.createElement("img");d.setAttribute("src",A);d.setAttribute("alt","thumbnail");d.style.display="block";d.style.position="absolute";d.style.border="2px solid #888888";d.style.borderRadius="5px";d.style.top=(I.top-6)+"px";d.style.right=(window.innerWidth-I.left+8)+"px";d.style.zIndex="100000";$("#viewer").appendChild(d)};var w=function(){if(d){d.style.display="none";d.remove()}d=null};j.handleclick=function(A){j.mark(A);if(v.isAligned){G(A)}};var B=function(A){let wc=Math.round(window.innerWidth*y);let x=(A.type=="mousemove"?A.pageX:A.changedTouches[0].pageX);j.focus=(x>=window.innerWidth-wc);if(z){A.preventDefault();A.stopPropagation();K(x-(window.innerWidth-wc-20))}};$("#viewer").addEventListener("mousemove",B);$("#viewer").addEventListener("touchmove",B)}ImageMapViewer.html='\n<div id="viewer" style="width: 100%; height: 100%">\n<div id="mapid" class="map" ></div>\n<div id="slider" bgcolor="#ff6600"></div>\n<canvas id="imgid">\n<p> Canvas not suported </p> \n</canvas> \n\n<div id="imgmenu2"></div>\n<div id="imgtitle"></div>\n<div id="confirm"></div>\n<div id="loadDlg">                \n</div>\n<img src="data:image/svg+xml,'+encodeURIComponent($.loadSVG)+'" id="loadicon" width=\'400\' height=\'400\' style="display: none; position: absolute; z-index: 1000000">\n</div>';ImageMapViewer.style="        \n#mapid {\nheight:100%;\nposition: absolute;\nleft: 0px;\ntop: 0px;\nmargin: 0px;\n}\n#slider {\nwidth: 20px;\nheight: 100%;\nposition: absolute;\ntop: 0px;\nmargin: 0px;\nbackground-color: #ff6600;\n\n}\n#thm {\nposition: absolute;\nborder-style: solid;\nborder-color: #888888;\nborder-radius: 5px;\nborder-width: 2px;\ndisplay: none;\n}";